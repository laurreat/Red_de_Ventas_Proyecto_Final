/**
 * Notificaciones en Tiempo Real - Líder v1.0
 * Sistema completo de notificaciones REALES con MongoDB
 */
class NotificationsManager{constructor(){this.config={updateInterval:15000,maxNotifications:10,autoMarkRead:!1};this.state={isLoading:!1,lastUpdate:null,notifications:[],unreadCount:0};this.init()}init(){this.loadNotifications();this.startRealTimeUpdates();this.setupEventListeners();console.log('[Notifications] Sistema iniciado con datos REALES')}async loadNotifications(){if(this.state.isLoading)return;this.state.isLoading=!0;try{const response=await fetch('/lider/notificaciones/nuevas',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json','X-CSRF-TOKEN':this.getCSRFToken()}});if(!response.ok)throw new Error('Failed to fetch');const data=await response.json();if(data.success){this.state.notifications=data.notifications||[];this.state.unreadCount=data.count||0;this.state.lastUpdate=Date.now();this.updateUI();console.log(`[Notifications] ${this.state.unreadCount} notificaciones cargadas`)}}catch(error){console.error('[Notifications] Error:',error)}finally{this.state.isLoading=!1}}updateUI(){this.updateBadge();this.updateDropdown()}updateBadge(){const badge=document.querySelector('.notification-badge');if(badge){if(this.state.unreadCount>0){badge.textContent=this.state.unreadCount>99?'99+':this.state.unreadCount;badge.style.display='flex'}else{badge.style.display='none'}}}updateDropdown(){const container=document.querySelector('.lider-header .dropdown-menu[style*="360px"] > div[style*="max-height"]');if(!container)return;if(this.state.notifications.length===0){container.innerHTML=`<div class="text-center py-5"><i class="bi bi-bell-slash fs-1 text-muted"></i><p class="text-muted mt-3 mb-0">No hay notificaciones nuevas</p></div>`;return}const html=this.state.notifications.slice(0,this.config.maxNotifications).map(notif=>this.createNotificationHTML(notif)).join('');container.innerHTML=html;const headerBadge=container.parentElement.querySelector('.badge');if(headerBadge){headerBadge.textContent=this.state.unreadCount>0?`${this.state.unreadCount} nuevas`:'Al día'}}createNotificationHTML(notif){const typeColors={success:'bg-success',info:'bg-primary',warning:'bg-warning',danger:'bg-danger'};const typeIcons={success:'check-circle-fill',info:'info-circle-fill',warning:'exclamation-triangle-fill',danger:'x-circle-fill'};const colorClass=typeColors[notif.type]||'bg-primary';const iconClass=typeIcons[notif.type]||'info-circle-fill';const titulo=notif.titulo?`<div class="fw-medium">${this.sanitizeHTML(notif.titulo)}</div>`:'';return`<div class="d-flex align-items-start notification-item" data-id="${notif.id}" data-read="${notif.leida||!1}"><div class="${colorClass} rounded-circle me-3" style="width: 10px; height: 10px; margin-top: 6px; flex-shrink: 0;"></div><div class="flex-grow-1">${titulo}<div class="fw-medium${titulo?'':' mb-1'}">${this.sanitizeHTML(notif.message)}</div><small class="text-muted"><i class="bi bi-clock"></i> ${this.sanitizeHTML(notif.timestamp)}</small></div></div>`}startRealTimeUpdates(){setInterval(()=>{if(!document.hidden){this.loadNotifications()}},this.config.updateInterval);document.addEventListener('visibilitychange',()=>{if(!document.hidden){this.loadNotifications()}})}setupEventListeners(){document.addEventListener('click',e=>{const notifItem=e.target.closest('.notification-item');if(notifItem){const id=notifItem.dataset.id;const isRead=notifItem.dataset.read==='true';if(!isRead&&this.config.autoMarkRead){this.markAsRead(id)}}});const verTodasBtn=document.querySelector('.lider-header .dropdown-menu[style*="360px"] .btn-outline-primary');if(verTodasBtn){verTodasBtn.addEventListener('click',e=>{e.preventDefault();this.showAllNotifications()})}}async markAsRead(id){try{const response=await fetch(`/lider/notificaciones/${id}/leer`,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json','Content-Type':'application/json','X-CSRF-TOKEN':this.getCSRFToken()}});if(response.ok){this.loadNotifications();console.log(`[Notifications] Marcada como leída: ${id}`)}}catch(error){console.error('[Notifications] Error al marcar:',error)}}async markAllAsRead(){try{const response=await fetch('/lider/notificaciones/marcar-todas',{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json','Content-Type':'application/json','X-CSRF-TOKEN':this.getCSRFToken()}});if(response.ok){this.state.unreadCount=0;this.updateBadge();console.log('[Notifications] Todas marcadas como leídas')}}catch(error){console.error('[Notifications] Error:',error)}}showAllNotifications(){alert('Centro de notificaciones - Próximamente disponible')}getCSRFToken(){const token=document.querySelector('meta[name="csrf-token"]');return token?token.getAttribute('content'):''}sanitizeHTML(str){if(typeof str!=='string')return'';const div=document.createElement('div');div.textContent=str;return div.innerHTML}showToast(message,type='info'){if(window.dashboardManager&&typeof window.dashboardManager.showToast==='function'){window.dashboardManager.showToast(message,type,3000)}else{console.log(`[Toast ${type}] ${message}`)}}destroy(){this.state={isLoading:!1,lastUpdate:null,notifications:[],unreadCount:0};console.log('[Notifications] Sistema detenido')}}let notificationsManager;document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{notificationsManager=new NotificationsManager()},500)});window.addEventListener('beforeunload',()=>{notificationsManager?.destroy()});if(typeof module!=='undefined'&&module.exports){module.exports=NotificationsManager}
