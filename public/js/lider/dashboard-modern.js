/**
 * Dashboard Líder Manager - Real-time Version 2.0
 * Minified & Optimized for <3s load time
 */
class DashboardManager{constructor(){this.updateInterval=30000;this.notificationInterval=15000;this.activityInterval=20000;this.updateTimer=null;this.notificationTimer=null;this.activityTimer=null;this.isUpdating=false;this.init()}init(){this.initAnimations();this.initModals();this.initToasts();this.initRealTimeUpdates();this.initNotifications();this.initActivityFeed();this.initChartAnimations();this.setupEventListeners();console.log('Dashboard Manager initialized with real-time updates')}initAnimations(){const cards=document.querySelectorAll('.dashboard-stat-card');cards.forEach((card,index)=>{card.style.animationDelay=`${index*0.1}s`;card.classList.add('animate-fade-in-up')});const items=document.querySelectorAll('.dashboard-activity-item, .dashboard-performer-item, .dashboard-product-item');items.forEach((item,index)=>{setTimeout(()=>{item.style.opacity='0';item.style.animation='fadeInUp 0.5s ease-out forwards';item.style.animationDelay=`${index*0.05}s`},300)})}initModals(){this.modals={};document.querySelectorAll('.dashboard-modal').forEach(modal=>{const id=modal.id;this.modals[id]={element:modal,backdrop:modal.previousElementSibling};modal.querySelector('.dashboard-modal-close')?.addEventListener('click',()=>this.closeModal(id));modal.previousElementSibling?.addEventListener('click',()=>this.closeModal(id))});document.addEventListener('keydown',e=>{if(e.key==='Escape'){Object.keys(this.modals).forEach(id=>this.closeModal(id))}})}showModal(id,type='info'){const modal=this.modals[id];if(!modal)return;modal.backdrop?.classList.add('active');modal.element.classList.add('active');modal.element.setAttribute('data-type',type)}closeModal(id){const modal=this.modals[id];if(!modal)return;modal.backdrop?.classList.remove('active');modal.element.classList.remove('active')}initToasts(){this.toastContainer=document.createElement('div');this.toastContainer.className='dashboard-toast-container';this.toastContainer.style.cssText='position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none';document.body.appendChild(this.toastContainer)}showToast(message,type='success',duration=3000){const toast=document.createElement('div');toast.className=`dashboard-toast ${type}`;toast.style.pointerEvents='all';const icon=this.getToastIcon(type);toast.innerHTML=`<i class="bi bi-${icon}"></i><span>${message}</span>`;this.toastContainer.appendChild(toast);setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>toast.remove(),300)},duration)}getToastIcon(type){const icons={success:'check-circle-fill',error:'x-circle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};return icons[type]||icons.info}showLoading(){let overlay=document.querySelector('.dashboard-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='dashboard-loading-overlay';overlay.innerHTML='<div class="dashboard-loading-spinner"></div>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.querySelector('.dashboard-loading-overlay');if(overlay){overlay.classList.remove('active')}}initRealTimeUpdates(){this.startRealTimeUpdates();document.addEventListener('visibilitychange',()=>{if(document.hidden){this.stopRealTimeUpdates()}else{this.startRealTimeUpdates()}})}startRealTimeUpdates(){this.updateTimer=setInterval(()=>this.updateDashboardStats(),this.updateInterval);console.log('Real-time updates started')}stopRealTimeUpdates(){if(this.updateTimer){clearInterval(this.updateTimer);this.updateTimer=null}if(this.notificationTimer){clearInterval(this.notificationTimer);this.notificationTimer=null}if(this.activityTimer){clearInterval(this.activityTimer);this.activityTimer=null}console.log('Real-time updates stopped')}async updateDashboardStats(){if(this.isUpdating)return;this.isUpdating=true;try{const response=await fetch('/lider/dashboard/stats',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)throw new Error('Failed to fetch stats');const data=await response.json();this.updateStatsUI(data);console.log('Dashboard stats updated')}catch(error){console.error('Error updating dashboard stats:',error)}finally{this.isUpdating=false}}updateStatsUI(data){if(data.stats){this.updateStatCard('equipo-total',data.stats.equipo_total);this.updateStatCard('ventas-mes',this.formatCurrency(data.stats.ventas_mes_actual));this.updateStatCard('comisiones-mes',this.formatCurrency(data.stats.comisiones_mes));this.updateStatCard('progreso-meta',`${data.stats.progreso_meta.toFixed(1)}%`)}if(data.metas){this.updateGoalsProgress(data.metas)}}updateStatCard(id,value){const element=document.querySelector(`[data-stat="${id}"]`);if(element){const currentValue=element.textContent;if(currentValue!==value.toString()){element.textContent=value;element.classList.add('animate-pulse');setTimeout(()=>element.classList.remove('animate-pulse'),600)}}}updateGoalsProgress(metas){Object.keys(metas).forEach(key=>{const meta=metas[key];const progressBar=document.querySelector(`[data-goal="${key}"] .dashboard-goal-progress-bar`);const badge=document.querySelector(`[data-goal="${key}"] .dashboard-goal-badge`);if(progressBar){progressBar.style.width=`${meta.progreso}%`}if(badge){badge.textContent=`${meta.progreso.toFixed(1)}%`}})}initNotifications(){this.startNotifications()}startNotifications(){this.notificationTimer=setInterval(()=>this.checkNotifications(),this.notificationInterval);this.checkNotifications()}async checkNotifications(){try{const response=await fetch('/lider/notificaciones/nuevas',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)return;const data=await response.json();if(data.notifications&&data.notifications.length>0){this.updateNotificationBadge(data.count);data.notifications.forEach(notif=>{this.showToast(notif.message,notif.type||'info',5000)})}}catch(error){console.error('Error checking notifications:',error)}}updateNotificationBadge(count){let badge=document.querySelector('.dashboard-notification-badge');if(count>0){if(!badge){badge=document.createElement('span');badge.className='dashboard-notification-badge';const bellIcon=document.querySelector('.bi-bell');if(bellIcon){bellIcon.parentElement.style.position='relative';bellIcon.parentElement.appendChild(badge)}}badge.textContent=count>99?'99+':count}else{badge?.remove()}}initActivityFeed(){this.startActivityFeed()}startActivityFeed(){this.activityTimer=setInterval(()=>this.updateActivityFeed(),this.activityInterval);console.log('Activity feed updates started')}async updateActivityFeed(){try{const response=await fetch('/lider/actividad/reciente',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)return;const data=await response.json();if(data.actividad&&data.actividad.length>0){this.updateActivityUI(data.actividad)}}catch(error){console.error('Error updating activity feed:',error)}}updateActivityUI(activities){const container=document.querySelector('.dashboard-activity-list');if(!container)return;const newActivities=activities.slice(0,5);newActivities.forEach((activity,index)=>{const exists=container.querySelector(`[data-activity-id="${activity.id}"]`);if(!exists){const activityHTML=this.createActivityHTML(activity);const tempDiv=document.createElement('div');tempDiv.innerHTML=activityHTML;const newItem=tempDiv.firstElementChild;newItem.style.opacity='0';container.insertBefore(newItem,container.firstChild);setTimeout(()=>{newItem.style.opacity='1';newItem.style.animation='fadeInUp 0.5s ease-out forwards'},index*100);const items=container.querySelectorAll('.dashboard-activity-item');if(items.length>15){items[items.length-1].remove()}}})}createActivityHTML(activity){const iconClass=activity.tipo==='pedido'?'cart-check':'person-plus';const gradient=activity.tipo==='pedido'?'linear-gradient(135deg, var(--wine), var(--wine-light))':'linear-gradient(135deg, var(--success), #059669)';return`<div class="dashboard-activity-item" data-activity-id="${activity.id}"><div class="dashboard-activity-icon" style="background:${gradient}"><i class="bi bi-${iconClass} text-white"></i></div><div class="dashboard-activity-content"><p class="dashboard-activity-title">${activity.descripcion}</p><small class="dashboard-activity-meta">${activity.tiempo}${activity.monto?` • $${this.formatNumber(activity.monto)}`:''}</small></div></div>`}initChartAnimations(){const canvas=document.getElementById('ventasChart');if(canvas&&typeof Chart!=='undefined'){this.animateChart(canvas)}}animateChart(canvas){setTimeout(()=>{const chart=Chart.getChart(canvas);if(chart){chart.update('active')}},500)}setupEventListeners(){document.querySelectorAll('[data-action="refresh"]').forEach(btn=>{btn.addEventListener('click',()=>{this.showLoading();this.updateDashboardStats();setTimeout(()=>{this.hideLoading();this.showToast('Datos actualizados correctamente','success')},1000)})});document.querySelectorAll('[data-action="export"]').forEach(btn=>{btn.addEventListener('click',()=>{this.showLoading();setTimeout(()=>{this.hideLoading();this.showToast('Exportación iniciada','info')},1500)})});const searchInput=document.querySelector('[data-search="dashboard"]');if(searchInput){searchInput.addEventListener('input',this.debounce(e=>{this.filterDashboard(e.target.value)},300))}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}filterDashboard(query){console.log('Filtering dashboard:',query)}formatCurrency(value){return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0}).format(value).replace('COP','$')}formatNumber(value){return new Intl.NumberFormat('es-CO').format(value)}destroy(){this.stopRealTimeUpdates();this.toastContainer?.remove();console.log('Dashboard Manager destroyed')}}let dashboardManager;document.addEventListener('DOMContentLoaded',()=>{dashboardManager=new DashboardManager()});window.addEventListener('beforeunload',()=>{dashboardManager?.destroy()});
