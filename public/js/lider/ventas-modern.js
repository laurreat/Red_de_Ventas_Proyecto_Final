class VentasManager{constructor(){if(VentasManager.instance){return VentasManager.instance}VentasManager.instance=this;this.modals={};this.toasts=[];this.init()}init(){this.initAnimations();this.initEventListeners();this.initTableAnimations();this.loadCharts()}initAnimations(){const cards=document.querySelectorAll('.ventas-stat-card,.ventas-filter-card,.ventas-table-container,.ventas-chart-container,.ventas-ranking-card');cards.forEach((card,i)=>{card.style.opacity='0';card.style.transform='translateY(20px)';setTimeout(()=>{card.style.transition='all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';card.style.opacity='1';card.style.transform='translateY(0)'},i*100)})}initEventListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape'){this.closeAllModals()}});const forms=document.querySelectorAll('form');forms.forEach(form=>{const searchInput=form.querySelector('input[type="text"]');if(searchInput){searchInput.addEventListener('input',this.debounce(e=>{console.log('Búsqueda:',e.target.value)},500))}});document.querySelectorAll('.ventas-action-btn').forEach(btn=>{btn.addEventListener('click',function(e){this.style.transform='scale(0.95)';setTimeout(()=>{this.style.transform=''},150)})})}initTableAnimations(){const rows=document.querySelectorAll('.ventas-table tbody tr');rows.forEach((row,i)=>{row.style.opacity='0';row.style.transform='translateX(-20px)';setTimeout(()=>{row.style.transition='all 0.4s ease-out';row.style.opacity='1';row.style.transform='translateX(0)'},i*50+300)})}loadCharts(){if(typeof Chart==='undefined'){console.warn('Chart.js no cargado');return}const chartContainers=document.querySelectorAll('canvas');chartContainers.forEach(canvas=>{const ctx=canvas.getContext('2d');if(canvas.id==='evolucionVentasChart'){this.createEvolucionChart(ctx)}else if(canvas.id==='ventasDiaChart'){this.createDiaChart(ctx)}})}createEvolucionChart(ctx){const data=window.evolucionVentasData||{labels:[],ventas:[],pedidos:[]};return new Chart(ctx,{type:'line',data:{labels:data.labels,datasets:[{label:'Ventas ($)',data:data.ventas,borderColor:'#722F37',backgroundColor:'rgba(114,47,55,0.1)',tension:0.4,fill:true,borderWidth:3,pointBackgroundColor:'#722F37',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:5,pointHoverRadius:7},{label:'Pedidos',data:data.pedidos,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',tension:0.4,fill:true,borderWidth:2,yAxisID:'y1',pointBackgroundColor:'#10b981',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{padding:15,font:{size:12,weight:'600'},color:'#1f2937',usePointStyle:true}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleColor:'#fff',bodyColor:'#fff',borderColor:'#722F37',borderWidth:1,displayColors:true,callbacks:{label:function(context){let label=context.dataset.label||'';if(label){label+=': '}if(context.parsed.y!==null){if(context.datasetIndex===0){label+='$'+context.parsed.y.toLocaleString()}else{label+=context.parsed.y}}return label}}}},scales:{y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)',drawBorder:false},ticks:{callback:function(value){return'$'+value.toLocaleString()},color:'#6b7280',font:{size:11}}},y1:{type:'linear',display:true,position:'right',beginAtZero:true,grid:{drawOnChartArea:false},ticks:{color:'#6b7280',font:{size:11}}},x:{grid:{display:false},ticks:{color:'#6b7280',font:{size:11}}}},interaction:{mode:'index',intersect:false}}})}createDiaChart(ctx){const data=window.ventasPorDiaData||{labels:[],ventas:[]};return new Chart(ctx,{type:'doughnut',data:{labels:data.labels,datasets:[{data:data.ventas,backgroundColor:['#722F37','#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#64748b'],borderWidth:0,hoverOffset:15}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11,weight:'600'},color:'#1f2937',usePointStyle:true,pointStyle:'circle'}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleColor:'#fff',bodyColor:'#fff',callbacks:{label:function(context){let label=context.label||'';if(label){label+=': '}if(context.parsed!==null){label+='$'+context.parsed.toLocaleString()}return label}}}},cutout:'65%'}})}createModal(config){const{id,title,content,type='primary',onConfirm,onCancel}=config;const modalId=id||'modal_'+Date.now();const typeColors={primary:'var(--wine)',success:'var(--success)',warning:'var(--warning)',danger:'var(--danger)',info:'var(--info)'};const backdrop=document.createElement('div');backdrop.className='ventas-modal-backdrop';backdrop.id=modalId+'_backdrop';backdrop.innerHTML=`
            <div class="ventas-modal" id="${modalId}">
                <div class="ventas-modal-header">
                    <h3 class="ventas-modal-title">
                        <i class="bi bi-${this.getIconByType(type)}"></i>
                        ${title}
                    </h3>
                    <button class="ventas-modal-close" onclick="ventasManager.closeModal('${modalId}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="ventas-modal-body">
                    ${content}
                </div>
                <div class="ventas-modal-footer">
                    ${onCancel?`<button class="ventas-action-btn" style="background:rgba(107,114,128,0.15);color:#374151;" onclick="ventasManager.closeModal('${modalId}')">
                        <i class="bi bi-x-circle"></i>Cancelar
                    </button>`:''}
                    ${onConfirm?`<button class="ventas-action-btn" style="background:${typeColors[type]};color:white;" onclick="ventasManager.handleConfirm('${modalId}')">
                        <i class="bi bi-check-circle"></i>Confirmar
                    </button>`:''}
                </div>
            </div>
        `;document.body.appendChild(backdrop);this.modals[modalId]={backdrop,onConfirm,onCancel};this.showModal(modalId);return modalId}showModal(modalId){const modal=this.modals[modalId];if(!modal)return;setTimeout(()=>{modal.backdrop.classList.add('show');modal.backdrop.querySelector('.ventas-modal').classList.add('show')},10);modal.backdrop.addEventListener('click',e=>{if(e.target===modal.backdrop){this.closeModal(modalId)}})}closeModal(modalId){const modal=this.modals[modalId];if(!modal)return;modal.backdrop.classList.remove('show');modal.backdrop.querySelector('.ventas-modal').classList.remove('show');setTimeout(()=>{modal.backdrop.remove();delete this.modals[modalId]},300)}handleConfirm(modalId){const modal=this.modals[modalId];if(modal&&modal.onConfirm){modal.onConfirm()}this.closeModal(modalId)}closeAllModals(){Object.keys(this.modals).forEach(id=>this.closeModal(id))}showToast(config){const{title='Notificación',message,type='info',duration=3000}=config;const toastId='toast_'+Date.now();const toast=document.createElement('div');toast.className=`ventas-toast ${type}`;toast.id=toastId;toast.innerHTML=`
            <div class="ventas-toast-icon ${type}">
                <i class="bi bi-${this.getIconByType(type)}"></i>
            </div>
            <div class="ventas-toast-content">
                <div class="ventas-toast-title">${title}</div>
                <div class="ventas-toast-message">${message}</div>
            </div>
            <button class="ventas-toast-close" onclick="ventasManager.closeToast('${toastId}')">
                <i class="bi bi-x"></i>
            </button>
        `;document.body.appendChild(toast);setTimeout(()=>toast.classList.add('show'),10);this.toasts.push(toastId);if(duration>0){setTimeout(()=>this.closeToast(toastId),duration)}}closeToast(toastId){const toast=document.getElementById(toastId);if(!toast)return;toast.classList.remove('show');setTimeout(()=>{toast.remove();this.toasts=this.toasts.filter(id=>id!==toastId)},300)}showLoading(text='Cargando...'){let loader=document.getElementById('ventas-loading');if(!loader){loader=document.createElement('div');loader.id='ventas-loading';loader.className='ventas-loading';loader.innerHTML=`
                <div class="ventas-spinner"></div>
                <div class="ventas-loading-text">${text}</div>
            `;document.body.appendChild(loader)}loader.classList.add('show')}hideLoading(){const loader=document.getElementById('ventas-loading');if(loader){loader.classList.remove('show');setTimeout(()=>loader.remove(),300)}}getIconByType(type){const icons={primary:'info-circle-fill',success:'check-circle-fill',warning:'exclamation-triangle-fill',danger:'x-circle-fill',info:'info-circle-fill'};return icons[type]||icons.info}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}exportarVentas(formato='csv'){const periodo=document.getElementById('periodo')?.value||'mes_actual';const vendedor=document.getElementById('vendedor')?.value||'';const estado=document.getElementById('estado')?.value||'';const params=new URLSearchParams({formato,periodo,vendedor,estado});this.showLoading('Exportando datos...');setTimeout(()=>{window.location.href=`/lider/ventas/exportar/datos?${params.toString()}`;this.hideLoading();this.showToast({title:'Éxito',message:`Exportación ${formato.toUpperCase()} iniciada. El archivo se descargará en breve.`,type:'success'})},1000)}verDetalle(id){this.showLoading('Cargando detalles...');setTimeout(()=>{window.location.href=`/lider/ventas/${id}`;this.hideLoading()},500)}filtrarVentas(){const form=document.querySelector('form');if(form){this.showLoading('Aplicando filtros...');form.submit()}}}const ventasManager=new VentasManager();if(typeof window!=='undefined'){window.ventasManager=ventasManager}document.addEventListener('DOMContentLoaded',()=>{const statCards=document.querySelectorAll('.ventas-stat-card');statCards.forEach(card=>{card.addEventListener('click',function(){this.style.transform='scale(0.98)';setTimeout(()=>{this.style.transform=''},200)})});const filterForm=document.querySelector('.ventas-filter-card form');if(filterForm){const submitBtn=filterForm.querySelector('button[type="submit"]');if(submitBtn){submitBtn.addEventListener('click',e=>{e.preventDefault();ventasManager.showLoading('Aplicando filtros...');setTimeout(()=>filterForm.submit(),300)})}}});
