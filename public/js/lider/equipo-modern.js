/**
 * Equipo Manager v1.0 - Minified & Optimized
 * PWA Ready | MongoDB Secure | <3s Load
 */
class EquipoManager{constructor(){this.config={animationDelay:100,searchDebounce:300,exportFormats:['excel','pdf','csv']};this.state={currentMember:null,filters:{search:'',estado:'',orden:'rendimiento'},isLoading:!1};this.init()}init(){this.initAnimations();this.initModals();this.initFilters();this.initActions();this.initTable();console.log('[Equipo] Manager initialized v1.0')}initAnimations(){requestAnimationFrame(()=>{document.querySelectorAll('.equipo-stat-card').forEach((card,idx)=>{card.style.animationDelay=`${idx*0.1}s`;card.classList.add('animate-fade-in-up')});setTimeout(()=>{document.querySelectorAll('.equipo-table tbody tr').forEach((row,idx)=>{row.style.opacity='0';row.style.animation='fadeInUp 0.5s ease-out forwards';row.style.animationDelay=`${idx*0.05}s`})},300)})}initModals(){this.modals={};document.querySelectorAll('[data-modal]').forEach(trigger=>{const modalId=trigger.dataset.modal;if(!document.getElementById(modalId))return;trigger.addEventListener('click',e=>{e.preventDefault();this.showModal(modalId,trigger.dataset)})});document.addEventListener('keydown',e=>{if(e.key==='Escape'){this.closeAllModals()}})}showModal(id,data={}){const backdrop=document.getElementById(`${id}-backdrop`)||this.createBackdrop(id);const modal=document.getElementById(id);if(!modal)return;if(data.memberId){this.state.currentMember=data.memberId;const form=modal.querySelector('form');if(form&&data.action){form.action=data.action}}backdrop.classList.add('active');modal.classList.add('active');document.body.classList.add('no-scroll');backdrop.addEventListener('click',e=>{if(e.target===backdrop)this.closeModal(id)})}closeModal(id){const backdrop=document.getElementById(`${id}-backdrop`);const modal=document.getElementById(id);if(backdrop)backdrop.classList.remove('active');if(modal)modal.classList.remove('active');document.body.classList.remove('no-scroll');this.state.currentMember=null}closeAllModals(){document.querySelectorAll('.equipo-modal.active').forEach(modal=>{this.closeModal(modal.id)})}createBackdrop(id){const backdrop=document.createElement('div');backdrop.id=`${id}-backdrop`;backdrop.className='equipo-modal-backdrop';document.body.appendChild(backdrop);return backdrop}initFilters(){const searchInput=document.querySelector('[name="search"]');if(searchInput){searchInput.addEventListener('input',this.debounce(e=>{this.state.filters.search=e.target.value;this.filterTable()},this.config.searchDebounce))}const estadoSelect=document.querySelector('[name="estado"]');if(estadoSelect){estadoSelect.addEventListener('change',e=>{this.state.filters.estado=e.target.value})}const ordenSelect=document.querySelector('[name="orden_por"]');if(ordenSelect){ordenSelect.addEventListener('change',e=>{this.state.filters.orden=e.target.value})}}filterTable(){const search=this.state.filters.search.toLowerCase();const rows=document.querySelectorAll('.equipo-table tbody tr');let visibleCount=0;rows.forEach(row=>{const text=row.textContent.toLowerCase();if(text.includes(search)){row.style.display='';visibleCount++}else{row.style.display='none'}});this.updateEmptyState(visibleCount===0)}updateEmptyState(isEmpty){let emptyState=document.querySelector('.equipo-empty-state');const tbody=document.querySelector('.equipo-table tbody');if(isEmpty){if(!emptyState){emptyState=document.createElement('div');emptyState.className='equipo-empty-state';emptyState.innerHTML=`<i class="bi bi-search"></i><h3>No se encontraron resultados</h3><p>Intenta con otros términos de búsqueda</p>`;tbody.parentElement.appendChild(emptyState)}}else{if(emptyState)emptyState.remove()}}initActions(){const assignMetaBtns=document.querySelectorAll('[data-action="assign-meta"]');assignMetaBtns.forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const memberId=btn.dataset.memberId;this.assignMeta(memberId)})});const sendMessageBtns=document.querySelectorAll('[data-action="send-message"]');sendMessageBtns.forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const memberId=btn.dataset.memberId;this.sendMessage(memberId)})});const exportBtn=document.querySelector('[data-action="export"]');if(exportBtn){exportBtn.addEventListener('click',e=>{e.preventDefault();this.exportData()})}}initTable(){const table=document.querySelector('.equipo-table');if(!table)return;const headers=table.querySelectorAll('thead th[data-sort]');headers.forEach(header=>{header.style.cursor='pointer';header.addEventListener('click',()=>{const column=header.dataset.sort;this.sortTable(column)})})}sortTable(column){const table=document.querySelector('.equipo-table tbody');const rows=Array.from(table.querySelectorAll('tr'));rows.sort((a,b)=>{const aVal=a.querySelector(`[data-${column}]`)?.dataset[column]||'0';const bVal=b.querySelector(`[data-${column}]`)?.dataset[column]||'0';return parseFloat(bVal)-parseFloat(aVal)});rows.forEach(row=>table.appendChild(row));this.showToast('Tabla ordenada correctamente','success')}assignMeta(memberId){this.showModal('metaModal',{memberId:memberId,action:`/lider/equipo/${memberId}/asignar-meta`})}sendMessage(memberId){this.showToast('Funcionalidad de mensajería próximamente','info')}exportData(){this.showLoading();setTimeout(()=>{this.hideLoading();this.showToast('Exportación iniciada','success');console.log('[Equipo] Exporting data...')},1500)}showToast(message,type='success'){if(window.dashboardManager&&typeof window.dashboardManager.showToast==='function'){window.dashboardManager.showToast(message,type,3000)}else{const toast=document.createElement('div');toast.className=`alert alert-${type} position-fixed top-0 end-0 m-3`;toast.style.zIndex='9999';toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>toast.remove(),3000)}}showLoading(){let overlay=document.querySelector('.equipo-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='equipo-loading-overlay';overlay.innerHTML='<div class="equipo-loading-spinner"></div><p class="text-muted">Cargando...</p>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.querySelector('.equipo-loading-overlay');if(overlay){overlay.classList.remove('active')}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}sanitizeHTML(str){if(typeof str!=='string')return'';const div=document.createElement('div');div.textContent=str;return div.innerHTML}formatCurrency(value){const num=parseFloat(value);return isNaN(num)?'$0':new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(num).replace('COP','$').trim()}destroy(){this.closeAllModals();const overlay=document.querySelector('.equipo-loading-overlay');if(overlay)overlay.remove();document.body.classList.remove('no-scroll');console.log('[Equipo] Manager destroyed')}}let equipoManager;document.addEventListener('DOMContentLoaded',()=>{try{equipoManager=new EquipoManager()}catch(error){console.error('[Equipo] Initialization failed:',error)}});window.addEventListener('beforeunload',()=>{equipoManager?.destroy()});if(typeof module!=='undefined'&&module.exports){module.exports=EquipoManager}
