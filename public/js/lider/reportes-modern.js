class ReportesManager{constructor(){this.currentTab='ventas';this.charts={};this.init()}init(){this.setupTableAnimations();this.setupEventListeners();this.animateStats();this.setupModalHandlers();this.setupChartResizeObserver()}setupTableAnimations(){const rows=document.querySelectorAll('.reportes-table tbody tr');rows.forEach((row,index)=>{row.style.opacity='0';row.style.animation=`fadeInUp 0.6s ease-out ${index*0.05}s forwards`})}setupEventListeners(){const filterForm=document.getElementById('reportesFilterForm');if(filterForm){filterForm.addEventListener('submit',()=>{this.showLoading('Generando reporte...')})}document.addEventListener('click',e=>{if(e.target.closest('.btn-ver-detalle')){e.preventDefault();const btn=e.target.closest('.btn-ver-detalle');const pedidoId=btn.dataset.pedidoId;if(pedidoId){this.showDetallePedido(pedidoId)}}if(e.target.closest('.btn-exportar')){e.preventDefault();this.exportarReporte()}if(e.target.closest('.reportes-tab')){e.preventDefault();const tab=e.target.closest('.reportes-tab');this.switchTab(tab.dataset.tab)}if(e.target.closest('.reportes-period-btn')){e.preventDefault();const btn=e.target.closest('.reportes-period-btn');this.changePeriod(btn.dataset.period)}})}animateStats(){const statCards=document.querySelectorAll('.reportes-stat-card');statCards.forEach((card,index)=>{card.style.opacity='0';card.style.animation=`scaleIn 0.6s ease-out ${index*0.1}s forwards`});const chartCards=document.querySelectorAll('.reportes-chart-card');chartCards.forEach((card,index)=>{card.style.opacity='0';card.style.animation=`fadeInUp 0.6s ease-out ${index*0.15}s forwards`})}setupModalHandlers(){document.addEventListener('keydown',e=>{if(e.key==='Escape'){this.closeAllModals()}})}setupChartResizeObserver(){if(typeof ResizeObserver!=='undefined'){const ro=new ResizeObserver(entries=>{entries.forEach(entry=>{const chartId=entry.target.querySelector('canvas')?.id;if(chartId&&this.charts[chartId]){this.charts[chartId].resize()}})});document.querySelectorAll('.reportes-chart-wrapper').forEach(wrapper=>{ro.observe(wrapper)})}}switchTab(tabName){if(!tabName)return;document.querySelectorAll('.reportes-tab').forEach(tab=>{tab.classList.remove('active')});const activeTab=document.querySelector(`.reportes-tab[data-tab="${tabName}"]`);if(activeTab){activeTab.classList.add('active')}document.querySelectorAll('.reportes-tab-content').forEach(content=>{content.style.display='none'});const activeContent=document.getElementById(`${tabName}-content`);if(activeContent){activeContent.style.display='block';activeContent.style.animation='fadeIn 0.4s ease'}this.currentTab=tabName}changePeriod(period){if(!period)return;document.querySelectorAll('.reportes-period-btn').forEach(btn=>{btn.classList.remove('active')});const activeBtn=document.querySelector(`.reportes-period-btn[data-period="${period}"]`);if(activeBtn){activeBtn.classList.add('active')}this.showLoading('Actualizando periodo...');const params=new URLSearchParams(window.location.search);params.set('periodo',period);window.location.href=`${window.location.pathname}?${params.toString()}`}showModal(modalId,type='primary'){const backdrop=this.createModalBackdrop();const modal=document.getElementById(modalId);if(!modal)return;backdrop.classList.add('show');modal.classList.add('show');if(type!=='primary'){const header=modal.querySelector('.reportes-modal-header');if(header){header.classList.add(type)}}backdrop.addEventListener('click',e=>{if(e.target===backdrop){this.closeModal(modalId)}});const closeBtn=modal.querySelector('.reportes-modal-close');if(closeBtn){closeBtn.addEventListener('click',()=>this.closeModal(modalId))}}closeModal(modalId){const modal=document.getElementById(modalId);const backdrop=document.querySelector('.reportes-modal-backdrop');if(modal){modal.classList.remove('show');setTimeout(()=>{modal.style.display='none'},300)}if(backdrop){backdrop.classList.remove('show');setTimeout(()=>{backdrop.remove()},300)}}closeAllModals(){const modals=document.querySelectorAll('.reportes-modal.show');modals.forEach(modal=>{this.closeModal(modal.id)})}createModalBackdrop(){const existing=document.querySelector('.reportes-modal-backdrop');if(existing)existing.remove();const backdrop=document.createElement('div');backdrop.className='reportes-modal-backdrop';document.body.appendChild(backdrop);return backdrop}showToast(message,type='success',title=''){const toast=document.createElement('div');toast.className=`reportes-toast ${type}`;const iconMap={success:'bi-check-circle-fill',error:'bi-x-circle-fill',danger:'bi-x-circle-fill',warning:'bi-exclamation-triangle-fill',info:'bi-info-circle-fill'};const titleMap={success:'Éxito',error:'Error',danger:'Error',warning:'Advertencia',info:'Información'};const icon=iconMap[type]||iconMap.success;const toastTitle=title||titleMap[type]||titleMap.success;toast.innerHTML=`<div class="reportes-toast-icon ${type}"><i class="bi ${icon}"></i></div><div class="reportes-toast-content"><div class="reportes-toast-title">${toastTitle}</div><div class="reportes-toast-message">${message}</div></div><button class="reportes-toast-close" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`;document.body.appendChild(toast);setTimeout(()=>toast.classList.add('show'),10);setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),400)},5000);return toast}showLoading(text='Cargando...'){const existing=document.querySelector('.reportes-loading');if(existing)return;const loading=document.createElement('div');loading.className='reportes-loading';loading.innerHTML=`<div class="reportes-spinner"></div><div class="reportes-loading-text">${text}</div>`;document.body.appendChild(loading);setTimeout(()=>loading.classList.add('show'),10);return loading}hideLoading(){const loading=document.querySelector('.reportes-loading');if(loading){loading.classList.remove('show');setTimeout(()=>loading.remove(),300)}}formatCurrency(amount){return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0}).format(amount)}formatNumber(number){return new Intl.NumberFormat('es-CO').format(number)}formatDate(date){return new Intl.DateTimeFormat('es-CO',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}).format(new Date(date))}formatPercentage(value){return `${value>=0?'+':''}${value.toFixed(2)}%`}async showDetallePedido(pedidoId){this.showLoading('Cargando detalles...');try{const response=await fetch(`/lider/pedidos/${pedidoId}`,{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.renderDetalleModal(data)}else{this.showToast(data.message||'Error al cargar los detalles','error')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('Error al cargar los detalles del pedido','error')}}renderDetalleModal(data){const modalHtml=`<div class="reportes-modal-backdrop show" id="detalleBackdrop"><div class="reportes-modal show large" id="detalleModal"><div class="reportes-modal-header info"><h3 class="reportes-modal-title"><i class="bi bi-receipt"></i>Detalle de Pedido #${data.numero_pedido}</h3><button class="reportes-modal-close" onclick="reportesManager.closeDetalleModal()"><i class="bi bi-x"></i></button></div><div class="reportes-modal-body"><div class="reportes-detail-row"><span class="reportes-detail-label">Cliente</span><span class="reportes-detail-value">${data.cliente.name}</span></div><div class="reportes-detail-row"><span class="reportes-detail-label">Vendedor</span><span class="reportes-detail-value">${data.vendedor.name}</span></div><div class="reportes-detail-row"><span class="reportes-detail-label">Fecha</span><span class="reportes-detail-value">${this.formatDate(data.created_at)}</span></div><div class="reportes-detail-row"><span class="reportes-detail-label">Estado</span><span class="reportes-detail-value"><span class="reportes-badge reportes-badge-${data.estado}">${data.estado}</span></span></div><div class="reportes-detail-row"><span class="reportes-detail-label">Total</span><span class="reportes-detail-value highlight">${this.formatCurrency(data.total_final)}</span></div></div><div class="reportes-modal-footer"><button type="button" class="reportes-btn reportes-btn-primary" onclick="reportesManager.closeDetalleModal()"><i class="bi bi-check-circle"></i>Cerrar</button></div></div></div>`;const container=document.createElement('div');container.innerHTML=modalHtml;document.body.appendChild(container.firstElementChild)}closeDetalleModal(){const backdrop=document.getElementById('detalleBackdrop');if(backdrop){backdrop.classList.remove('show');setTimeout(()=>backdrop.remove(),300)}}exportarReporte(){const form=document.getElementById('reportesFilterForm')||document.createElement('form');const formData=new FormData(form);formData.append('tipo',this.currentTab);formData.append('formato','excel');const params=new URLSearchParams(formData);this.showLoading('Generando archivo...');window.location.href=`/lider/reportes/exportar?${params.toString()}`;setTimeout(()=>{this.hideLoading();this.showToast('Reporte exportado correctamente','success')},2000)}initChart(canvasId,type,data,options={}){const ctx=document.getElementById(canvasId);if(!ctx)return null;if(typeof Chart==='undefined'){console.warn('Chart.js no está cargado');return null}const defaultOptions={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{usePointStyle:true,padding:15,font:{size:12,weight:'600'}}},tooltip:{backgroundColor:'rgba(31, 41, 55, 0.95)',padding:12,titleFont:{size:14,weight:'700'},bodyFont:{size:13},borderColor:'rgba(114, 47, 55, 0.2)',borderWidth:1,cornerRadius:8,displayColors:true,callbacks:{label:function(context){let label=context.dataset.label||'';if(label){label+=': '}if(context.parsed.y!==null){label+=new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(context.parsed.y)}return label}}}},scales:{x:{grid:{display:false,borderColor:'rgba(114, 47, 55, 0.1)'},ticks:{font:{size:11,weight:'600'},color:'#6b7280'}},y:{grid:{color:'rgba(114, 47, 55, 0.05)',borderColor:'rgba(114, 47, 55, 0.1)'},ticks:{font:{size:11,weight:'600'},color:'#6b7280',callback:function(value){return new Intl.NumberFormat('es-CO',{notation:'compact',compactDisplay:'short'}).format(value)}}}}};const mergedOptions={...defaultOptions,...options};this.charts[canvasId]=new Chart(ctx,{type:type,data:data,options:mergedOptions});return this.charts[canvasId]}updateChart(canvasId,newData){if(this.charts[canvasId]){this.charts[canvasId].data=newData;this.charts[canvasId].update()}}destroyChart(canvasId){if(this.charts[canvasId]){this.charts[canvasId].destroy();delete this.charts[canvasId]}}animateNumber(element,endValue,duration=1500){if(!element)return;const startValue=0;const startTime=performance.now();const step=(currentTime)=>{const elapsed=currentTime-startTime;const progress=Math.min(elapsed/duration,1);const currentValue=startValue+(endValue-startValue)*this.easeOutQuart(progress);element.textContent=this.formatNumber(Math.floor(currentValue));if(progress<1){requestAnimationFrame(step)}else{element.textContent=this.formatNumber(endValue)}};requestAnimationFrame(step)}easeOutQuart(x){return 1-Math.pow(1-x,4)}debounce(func,wait=300){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}setupSearchFilter(inputId,tableId){const input=document.getElementById(inputId);const table=document.getElementById(tableId);if(!input||!table)return;input.addEventListener('input',this.debounce(e=>{const filter=e.target.value.toLowerCase();const rows=table.querySelectorAll('tbody tr');rows.forEach(row=>{const text=row.textContent.toLowerCase();row.style.display=text.includes(filter)?'':'none'})}))}}let reportesManager;document.addEventListener('DOMContentLoaded',()=>{reportesManager=new ReportesManager()});if(typeof window!=='undefined'){window.reportesManager=reportesManager}
