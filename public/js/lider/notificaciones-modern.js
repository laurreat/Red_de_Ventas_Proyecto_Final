class NotificacionesManager{constructor(){this.routes=window.notificacionesRoutes||{};this.csrf=window.notificacionesCSRF||'';this.activeModal=null;this.activeBackdrop=null;this.init()}init(){this.addAnimations();this.setupEventListeners();console.log('✅ NotificacionesManager (Líder) initialized')}addAnimations(){const items=document.querySelectorAll('.notif-item');items.forEach((item,index)=>{item.classList.add('fade-in-up');item.style.animationDelay=`${index*0.05}s`});const cards=document.querySelectorAll('.notif-stat-card');cards.forEach((card,index)=>{card.classList.add('scale-in');card.style.animationDelay=`${index*0.1}s`})}setupEventListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape'&&this.activeModal){this.closeModal()}})}createModal(type,title,message){const backdrop=document.createElement('div');backdrop.className='notif-modal-backdrop';const modal=document.createElement('div');modal.className='notif-modal';const iconMap={success:'✓',warning:'⚠',danger:'✕',info:'ℹ',primary:'●'};const icon=iconMap[type]||iconMap.info;modal.innerHTML=`<div class="notif-modal-content"><div class="notif-modal-header"><h5 class="notif-modal-title ${type}"><span>${icon}</span> ${title}</h5><button class="notif-modal-close" onclick="window.notificacionesManager.closeModal()">✕</button></div><div class="notif-modal-body">${message}</div><div class="notif-modal-footer" id="modal-footer"></div></div>`;document.body.appendChild(backdrop);document.body.appendChild(modal);this.activeBackdrop=backdrop;this.activeModal=modal;setTimeout(()=>{backdrop.classList.add('active');modal.classList.add('active')},10);backdrop.onclick=e=>{if(e.target===backdrop){this.closeModal()}};return modal}showModal(type,title,message,buttons=[]){const modal=this.createModal(type,title,message);const footer=modal.querySelector('#modal-footer');if(buttons.length===0){buttons=[{text:'Aceptar',type:'primary',action:()=>this.closeModal()}]}buttons.forEach(btn=>{const button=document.createElement('button');button.className=`notif-modal-btn notif-modal-btn-${btn.type||'secondary'}`;button.textContent=btn.text;button.onclick=()=>{if(btn.action){btn.action()}};footer.appendChild(button)})}closeModal(){if(this.activeModal){this.activeBackdrop.classList.remove('active');this.activeModal.classList.remove('active');setTimeout(()=>{if(this.activeBackdrop)this.activeBackdrop.remove();if(this.activeModal)this.activeModal.remove();this.activeBackdrop=null;this.activeModal=null},300)}}showToast(type,message,duration=3000){const toast=document.createElement('div');toast.className=`notif-toast notif-toast-${type}`;const iconMap={success:'✓',error:'✕',warning:'⚠',info:'ℹ'};const icon=iconMap[type]||iconMap.info;toast.innerHTML=`<div class="notif-toast-content"><span class="notif-toast-icon">${icon}</span><span class="notif-toast-message">${message}</span></div>`;document.body.appendChild(toast);setTimeout(()=>toast.classList.add('active'),10);setTimeout(()=>{toast.classList.remove('active');setTimeout(()=>toast.remove(),300)},duration)}showLoading(){let overlay=document.getElementById('notif-loading');if(!overlay){overlay=document.createElement('div');overlay.id='notif-loading';overlay.className='notif-loading-overlay';overlay.innerHTML='<div class="notif-loading-spinner"></div>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.getElementById('notif-loading');if(overlay){overlay.classList.remove('active')}}async marcarLeida(id){const url=this.routes.marcarLeida?.replace(':id',id);if(!url)return this.showToast('error','URL no configurada');try{this.showLoading();const response=await fetch(url,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrf,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success','Notificación marcada como leída');setTimeout(()=>location.reload(),1000)}else{this.showToast('error',data.message||'Error al marcar como leída')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('error','Error de conexión')}}async marcarTodasLeidas(){this.showModal('warning','Confirmar Acción','¿Estás seguro de marcar todas las notificaciones como leídas?',[{text:'Cancelar',type:'secondary',action:()=>this.closeModal()},{text:'Confirmar',type:'primary',action:async()=>{this.closeModal();const url=this.routes.marcarTodasLeidas;if(!url)return this.showToast('error','URL no configurada');try{this.showLoading();const response=await fetch(url,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrf,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success',data.message);setTimeout(()=>location.reload(),1500)}else{this.showToast('error',data.message||'Error al marcar como leídas')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('error','Error de conexión')}}}])}async eliminarNotificacion(id){this.showModal('danger','Eliminar Notificación','¿Estás seguro de eliminar esta notificación? Esta acción no se puede deshacer.',[{text:'Cancelar',type:'secondary',action:()=>this.closeModal()},{text:'Eliminar',type:'primary',action:async()=>{this.closeModal();const url=this.routes.eliminar?.replace(':id',id);if(!url)return this.showToast('error','URL no configurada');try{this.showLoading();const response=await fetch(url,{method:'DELETE',headers:{'X-CSRF-TOKEN':this.csrf,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success','Notificación eliminada');setTimeout(()=>location.reload(),1000)}else{this.showToast('error',data.message||'Error al eliminar')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('error','Error de conexión')}}}])}async limpiarLeidas(){this.showModal('warning','Limpiar Notificaciones','¿Deseas eliminar todas las notificaciones leídas?',[{text:'Cancelar',type:'secondary',action:()=>this.closeModal()},{text:'Limpiar',type:'primary',action:async()=>{this.closeModal();const url=this.routes.limpiarLeidas;if(!url)return this.showToast('error','URL no configurada');try{this.showLoading();const response=await fetch(url,{method:'DELETE',headers:{'X-CSRF-TOKEN':this.csrf,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success',data.message);setTimeout(()=>location.reload(),1500)}else{this.showToast('error',data.message||'Error al limpiar')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('error','Error de conexión')}}}])}async crearNotificacionesPrueba(){this.showModal('info','Crear Notificaciones de Prueba','¿Deseas crear notificaciones de prueba para probar el sistema?',[{text:'Cancelar',type:'secondary',action:()=>this.closeModal()},{text:'Crear',type:'primary',action:async()=>{this.closeModal();const url=this.routes.crearPruebas;if(!url)return this.showToast('error','URL no configurada');try{this.showLoading();const response=await fetch(url,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrf,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success',data.message);setTimeout(()=>location.reload(),1500)}else{this.showToast('error',data.message||'Error al crear')}}catch(error){this.hideLoading();console.error('Error:',error);this.showToast('error','Error de conexión')}}}])}}document.addEventListener('DOMContentLoaded',()=>{window.notificacionesManager=new NotificacionesManager()});window.marcarLeida=id=>window.notificacionesManager?.marcarLeida(id);window.marcarTodasLeidas=()=>window.notificacionesManager?.marcarTodasLeidas();window.eliminarNotificacion=id=>window.notificacionesManager?.eliminarNotificacion(id);window.limpiarLeidas=()=>window.notificacionesManager?.limpiarLeidas();window.crearNotificacionesPrueba=()=>window.notificacionesManager?.crearNotificacionesPrueba();
