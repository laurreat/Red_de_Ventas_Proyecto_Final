/* Dashboard Vendedor Modern v1.0 - Minified & Optimized | PWA Ready | MongoDB Secure */
class DashboardManager{constructor(){this.modals=new Map();this.charts=new Map();this.init()}init(){this.setupEventListeners();this.initializeCharts();this.animateElements();this.setupReferralCode();this.setupPWAHandlers()}setupEventListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape')this.closeAllModals()});document.querySelectorAll('[data-modal-trigger]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const modalId=btn.dataset.modalTrigger;this.showModal(modalId)})});document.querySelectorAll('.vendedor-modal-backdrop, .vendedor-modal-close').forEach(el=>{el.addEventListener('click',e=>{if(e.target===e.currentTarget||e.target.closest('.vendedor-modal-close')){this.closeModal(e.target.closest('.vendedor-modal-backdrop, .vendedor-modal').dataset.modalId||this.getActiveModalId())}})});window.addEventListener('online',()=>this.handleOnlineStatus(true));window.addEventListener('offline',()=>this.handleOnlineStatus(false))}initializeCharts(){const ventasChartEl=document.getElementById('ventasChart');if(ventasChartEl&&typeof Chart!=='undefined'){const ctx=ventasChartEl.getContext('2d');const evolucionData=window.evolucionVentasData||[];this.charts.set('ventas',new Chart(ctx,{type:'line',data:{labels:evolucionData.map(d=>d.mes),datasets:[{label:'Ventas ($)',data:evolucionData.map(d=>d.ventas),borderColor:'#722F37',backgroundColor:'rgba(114,47,55,0.1)',borderWidth:3,fill:!0,tension:.4,pointBackgroundColor:'#722F37',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:5,pointHoverRadius:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'#722F37',borderWidth:1,callbacks:{label:ctx=>'Ventas: $'+ctx.parsed.y.toLocaleString()}}},scales:{y:{beginAtZero:!0,grid:{color:'rgba(0,0,0,0.05)'},ticks:{callback:val=>'$'+val.toLocaleString(),font:{size:12}}},x:{grid:{display:!1},ticks:{font:{size:12}}}},interaction:{mode:'index',intersect:!1},animation:{duration:1000,easing:'easeInOutQuart'}}}))}this.initDoughnutChart()}initDoughnutChart(){const doughnutEl=document.getElementById('categoriasChart');if(doughnutEl&&typeof Chart!=='undefined'){const ctx=doughnutEl.getContext('2d');const categoriasData=window.categoriasVentasData||[];if(categoriasData.length>0){this.charts.set('categorias',new Chart(ctx,{type:'doughnut',data:{labels:categoriasData.map(d=>d.categoria),datasets:[{data:categoriasData.map(d=>d.total),backgroundColor:['#722F37','#8d3a44','#a14a56','#10b981','#3b82f6','#f59e0b'],borderWidth:2,borderColor:'#fff',hoverBorderWidth:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:12},usePointStyle:!0}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',padding:12,callbacks:{label:ctx=>ctx.label+': $'+ctx.parsed.toLocaleString()}}},animation:{animateRotate:!0,animateScale:!0,duration:1000}}}))}}}animateElements(){const observerOptions={threshold:.1,rootMargin:'0px 0px -50px 0px'};const observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add('animate-fade-in-up');observer.unobserve(entry.target)}})},observerOptions);document.querySelectorAll('.vendedor-stat-card, .vendedor-quick-action-btn, .vendedor-recent-item, .vendedor-activity-item').forEach(el=>observer.observe(el));this.animateProgressBars();this.animateCounters()}animateProgressBars(){setTimeout(()=>{document.querySelectorAll('.vendedor-stat-progress-bar, .vendedor-progress-bar-fill, .progress-bar').forEach(bar=>{const targetWidth=bar.dataset.width||bar.style.width||'0%';bar.style.width='0%';setTimeout(()=>{bar.style.transition='width 1s cubic-bezier(0.4, 0, 0.2, 1)';bar.style.width=targetWidth},100)})},300)}animateCounters(){document.querySelectorAll('.vendedor-stat-value').forEach(el=>{const target=parseInt(el.textContent.replace(/[^0-9]/g,'')||0);if(target>0){let current=0;const increment=target/50;const timer=setInterval(()=>{current+=increment;if(current>=target){el.textContent='$'+target.toLocaleString();clearInterval(timer)}else{el.textContent='$'+Math.floor(current).toLocaleString()}},20)}})}setupReferralCode(){const copyBtn=document.getElementById('copyReferralBtn');if(copyBtn){copyBtn.addEventListener('click',()=>{const code=copyBtn.dataset.code;if(navigator.clipboard&&code){navigator.clipboard.writeText(code).then(()=>{this.showToast('Código copiado al portapapeles','success');copyBtn.innerHTML='<i class="bi bi-check-lg"></i> Copiado';setTimeout(()=>{copyBtn.innerHTML='<i class="bi bi-clipboard"></i> Copiar código'},2000)}).catch(()=>{this.fallbackCopyCode(code)})}else{this.fallbackCopyCode(code)}})}}fallbackCopyCode(code){const textarea=document.createElement('textarea');textarea.value=code;textarea.style.position='fixed';textarea.style.opacity='0';document.body.appendChild(textarea);textarea.select();try{document.execCommand('copy');this.showToast('Código copiado al portapapeles','success')}catch(err){this.showToast('No se pudo copiar el código','error')}document.body.removeChild(textarea)}createModal(id,title,body,footer,type='primary'){const modalHTML=`
<div class="vendedor-modal-backdrop" data-modal-id="${id}">
<div class="vendedor-modal" data-modal-id="${id}">
<div class="vendedor-modal-content">
<div class="vendedor-modal-header">
<h3 class="vendedor-modal-title text-${type}">
<i class="bi bi-${this.getModalIcon(type)}"></i>${title}
</h3>
<button type="button" class="vendedor-modal-close" aria-label="Cerrar">
<i class="bi bi-x-lg"></i>
</button>
</div>
<div class="vendedor-modal-body">${body}</div>
${footer?`<div class="vendedor-modal-footer">${footer}</div>`:''}
</div>
</div>
</div>`;const div=document.createElement('div');div.innerHTML=modalHTML;document.body.appendChild(div.firstElementChild);this.modals.set(id,div.firstElementChild);this.setupModalEvents(id);return id}showModal(id){const modal=this.modals.get(id)||document.querySelector(`[data-modal-id="${id}"]`);if(modal){modal.classList.add('active');modal.querySelector('.vendedor-modal').classList.add('active');document.body.classList.add('no-scroll');setTimeout(()=>modal.querySelector('.vendedor-modal-close')?.focus(),100)}}closeModal(id){const modal=this.modals.get(id)||document.querySelector(`[data-modal-id="${id}"]`);if(modal){modal.classList.remove('active');modal.querySelector('.vendedor-modal')?.classList.remove('active');document.body.classList.remove('no-scroll')}}closeAllModals(){this.modals.forEach((modal,id)=>this.closeModal(id));document.querySelectorAll('.vendedor-modal-backdrop.active').forEach(backdrop=>{backdrop.classList.remove('active');backdrop.querySelector('.vendedor-modal')?.classList.remove('active')});document.body.classList.remove('no-scroll')}getActiveModalId(){const activeModal=document.querySelector('.vendedor-modal.active');return activeModal?.dataset.modalId||null}setupModalEvents(id){const modal=this.modals.get(id);if(!modal)return;const backdrop=modal;const closeBtn=modal.querySelector('.vendedor-modal-close');backdrop?.addEventListener('click',e=>{if(e.target===backdrop)this.closeModal(id)});closeBtn?.addEventListener('click',()=>this.closeModal(id))}getModalIcon(type){const icons={primary:'info-circle',success:'check-circle',warning:'exclamation-triangle',danger:'exclamation-circle',info:'info-circle'};return icons[type]||'info-circle'}showToast(message,type='info',duration=3000){const toastId='toast-'+Date.now();const toast=document.createElement('div');toast.className=`vendedor-toast ${type}`;toast.id=toastId;toast.innerHTML=`<i class="bi bi-${this.getToastIcon(type)}"></i><span>${message}</span>`;document.body.appendChild(toast);setTimeout(()=>{toast.style.animation='slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) reverse';setTimeout(()=>toast.remove(),300)},duration)}getToastIcon(type){const icons={success:'check-circle-fill',error:'x-circle-fill',danger:'x-circle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};return icons[type]||'info-circle-fill'}showLoading(message='Cargando...'){const overlay=document.createElement('div');overlay.className='vendedor-loading-overlay active';overlay.innerHTML=`
<div class="vendedor-loading-spinner"></div>
<div style="margin-top: 1rem; font-weight: 600; color: var(--wine);">${message}</div>`;overlay.id='vendedor-loading';document.body.appendChild(overlay);document.body.classList.add('no-scroll')}hideLoading(){const overlay=document.getElementById('vendedor-loading');if(overlay){overlay.classList.remove('active');setTimeout(()=>{overlay.remove();document.body.classList.remove('no-scroll')},300)}}setupPWAHandlers(){if('serviceWorker'in navigator){this.checkPWAInstallPrompt()}window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();this.deferredPrompt=e;this.showPWAInstallPrompt()})}checkPWAInstallPrompt(){const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;if(!isStandalone&&!localStorage.getItem('pwa-install-dismissed')){setTimeout(()=>this.showPWAInstallBanner(),5000)}}showPWAInstallBanner(){const banner=document.createElement('div');banner.className='vendedor-toast info';banner.innerHTML=`
<i class="bi bi-app-indicator"></i>
<span>¿Instalar app en tu dispositivo?</span>
<button onclick="dashboardManager.installPWA()" class="vendedor-btn-sm vendedor-btn-wine" style="margin-left: 0.5rem; padding: 0.375rem 0.875rem; font-size: 0.75rem;">Instalar</button>
<button onclick="this.parentElement.remove(); localStorage.setItem('pwa-install-dismissed','true')" class="vendedor-btn-sm" style="margin-left: 0.25rem; padding: 0.375rem 0.875rem; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 0.75rem;">Luego</button>`;banner.style.top='auto';banner.style.bottom='24px';banner.style.maxWidth='500px';document.body.appendChild(banner);setTimeout(()=>banner.remove(),15000)}async installPWA(){if(this.deferredPrompt){this.deferredPrompt.prompt();const{outcome}=await this.deferredPrompt.userChoice;if(outcome==='accepted'){this.showToast('¡Aplicación instalada correctamente!','success');localStorage.setItem('pwa-install-dismissed','true')}this.deferredPrompt=null;document.querySelectorAll('.vendedor-toast').forEach(t=>t.remove())}}handleOnlineStatus(isOnline){if(isOnline){this.showToast('Conexión restaurada','success',2000)}else{this.showToast('Sin conexión a internet','warning',4000)}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}refreshData(){this.showLoading('Actualizando datos...');fetch(window.location.href,{headers:{' X-Requested-With':'XMLHttpRequest'}}).then(response=>response.json()).then(data=>{this.updateDashboardData(data);this.showToast('Datos actualizados','success');this.hideLoading()}).catch(error=>{console.error('Error refreshing data:',error);this.showToast('Error al actualizar datos','error');this.hideLoading()})}updateDashboardData(data){if(data.stats){Object.keys(data.stats).forEach(key=>{const el=document.querySelector(`[data-stat="${key}"]`);if(el)el.textContent=data.stats[key]})}if(data.evolucionVentas&&this.charts.has('ventas')){const chart=this.charts.get('ventas');chart.data.labels=data.evolucionVentas.map(d=>d.mes);chart.data.datasets[0].data=data.evolucionVentas.map(d=>d.ventas);chart.update()}}destroy(){this.charts.forEach(chart=>chart.destroy());this.modals.forEach(modal=>modal.remove());this.charts.clear();this.modals.clear()}}let dashboardManager;document.addEventListener('DOMContentLoaded',()=>{dashboardManager=new DashboardManager();if(typeof Chart!=='undefined'&&document.getElementById('ventasChart')){window.evolucionVentasData=typeof evolucionVentasData!=='undefined'?evolucionVentasData:[]}});window.addEventListener('beforeunload',()=>{if(dashboardManager){dashboardManager.destroy()}});if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js').catch(err=>console.log('SW registration failed:',err))})}
