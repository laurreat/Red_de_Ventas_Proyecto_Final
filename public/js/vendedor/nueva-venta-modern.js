/**Nueva Venta Manager-JS Profesional Minificado v2.0*/
class NuevaVentaManager{constructor(){this.productos=[];this.cliente=null;this.subtotal=0;this.descuento=0;this.iva=0;this.total=0;this.searchTimeout=null;this.init()}init(){this.initEventListeners();this.initAnimations();this.updateTotales()}initAnimations(){const elements=document.querySelectorAll('.fade-in-up, .scale-in, .animate-delay-1, .animate-delay-2, .animate-delay-3');elements.forEach((el,idx)=>{setTimeout(()=>el.style.opacity='1',idx*100)})}initEventListeners(){const clienteSearch=document.getElementById('cliente-search');if(clienteSearch){clienteSearch.addEventListener('input',(e)=>this.buscarCliente(e.target.value))}const productoSearch=document.getElementById('producto-search');if(productoSearch){productoSearch.addEventListener('input',(e)=>this.buscarProducto(e.target.value))}const addProductoBtn=document.getElementById('add-producto-btn');if(addProductoBtn){addProductoBtn.addEventListener('click',()=>this.mostrarBusquedaProducto())}const descuentoInput=document.getElementById('descuento');if(descuentoInput){descuentoInput.addEventListener('input',(e)=>{this.descuento=parseFloat(e.target.value)||0;this.updateTotales()})}const form=document.getElementById('nueva-venta-form');if(form){form.addEventListener('submit',(e)=>this.submitForm(e))}document.addEventListener('click',(e)=>{if(!e.target.closest('.venta-search-container')){this.closeSearchResults()}})}buscarCliente(termino){clearTimeout(this.searchTimeout);if(termino.length<2){this.closeSearchResults('cliente');return}this.searchTimeout=setTimeout(()=>{fetch(`/vendedor/ventas/buscar-cliente?q=${encodeURIComponent(termino)}`).then(r=>r.json()).then(clientes=>{this.mostrarResultadosCliente(clientes)}).catch(err=>console.error('Error buscando cliente:',err))},300)}mostrarResultadosCliente(clientes){const results=document.getElementById('cliente-search-results');if(!results)return;if(clientes.length===0){results.innerHTML='<div class="venta-search-item"><span>No se encontraron clientes</span></div>';results.classList.add('active');return}results.innerHTML=clientes.map(c=>`
<div class="venta-search-item" onclick="nuevaVentaManager.seleccionarCliente('${c._id}','${c.name||c.nombre}','${c.email}')">
<div>
<div class="venta-search-item-name">${c.name||c.nombre}</div>
<div class="venta-search-item-detail">${c.email}</div>
</div>
<div class="venta-search-item-detail">${c.telefono||''}</div>
</div>`).join('');results.classList.add('active')}seleccionarCliente(id,nombre,email){this.cliente={id,nombre,email};document.getElementById('cliente-search').value=`${nombre} (${email})`;document.getElementById('cliente_id').value=id;this.closeSearchResults('cliente');this.showToast(`Cliente seleccionado: ${nombre}`,'success')}buscarProducto(termino){clearTimeout(this.searchTimeout);if(termino.length<2){this.closeSearchResults('producto');return}this.searchTimeout=setTimeout(()=>{fetch(`/vendedor/ventas/buscar-producto?q=${encodeURIComponent(termino)}`).then(r=>r.json()).then(productos=>{this.mostrarResultadosProducto(productos)}).catch(err=>console.error('Error buscando producto:',err))},300)}mostrarResultadosProducto(productos){const results=document.getElementById('producto-search-results');if(!results)return;if(productos.length===0){results.innerHTML='<div class="venta-search-item"><span>No se encontraron productos</span></div>';results.classList.add('active');return}results.innerHTML=productos.map(p=>`
<div class="venta-search-item" onclick="nuevaVentaManager.agregarProducto('${p._id}','${p.nombre}','${p.codigo||''}',${p.precio},${p.stock})">
<div>
<div class="venta-search-item-name">${p.nombre}</div>
<div class="venta-search-item-detail">C\u00f3digo: ${p.codigo||'N/A'} | Stock: ${p.stock}</div>
</div>
<div class="venta-search-item-detail">$${parseFloat(p.precio).toFixed(2)}</div>
</div>`).join('');results.classList.add('active')}agregarProducto(id,nombre,codigo,precio,stock){const existe=this.productos.find(p=>p.id===id);if(existe){existe.cantidad++;this.updateCantidad(id,existe.cantidad)}else{this.productos.push({id,nombre,codigo,precio:parseFloat(precio),cantidad:1,stock});this.renderProductos()}document.getElementById('producto-search').value='';this.closeSearchResults('producto');this.updateTotales();this.showToast(`Producto agregado: ${nombre}`,'success')}renderProductos(){const container=document.getElementById('productos-list');if(!container)return;if(this.productos.length===0){container.innerHTML='<p style="text-align:center;color:var(--gray-500);padding:2rem;">No hay productos agregados</p>';return}container.innerHTML=this.productos.map((p,idx)=>`
<div class="venta-producto-item fade-in-up" style="animation-delay:${idx*.05}s">
<div class="venta-producto-index">${idx+1}</div>
<div class="venta-producto-info">
<p class="venta-producto-nombre">${p.nombre}</p>
<p class="venta-producto-codigo">C\u00f3digo: ${p.codigo||'N/A'} | Stock: ${p.stock}</p>
</div>
<div class="venta-producto-cantidad">
<input type="number" min="1" max="${p.stock}" value="${p.cantidad}"
onchange="nuevaVentaManager.updateCantidad('${p.id}',this.value)">
</div>
<div class="venta-producto-precio">
$${(p.precio*p.cantidad).toFixed(2)}
</div>
<button type="button" class="venta-producto-remove" onclick="nuevaVentaManager.removerProducto('${p.id}')">
&times;
</button>
<input type="hidden" name="productos[${idx}][id]" value="${p.id}">
<input type="hidden" name="productos[${idx}][cantidad]" value="${p.cantidad}">
<input type="hidden" name="productos[${idx}][precio]" value="${p.precio}">
</div>`).join('')}updateCantidad(id,cantidad){const producto=this.productos.find(p=>p.id===id);if(producto){cantidad=parseInt(cantidad);if(cantidad>producto.stock){this.showToast(`Stock insuficiente. M\u00e1ximo: ${producto.stock}`,'warning');cantidad=producto.stock}if(cantidad<1)cantidad=1;producto.cantidad=cantidad;this.renderProductos();this.updateTotales()}}removerProducto(id){this.productos=this.productos.filter(p=>p.id!==id);this.renderProductos();this.updateTotales();this.showToast('Producto removido','info')}updateTotales(){this.subtotal=this.productos.reduce((sum,p)=>sum+(p.precio*p.cantidad),0);this.iva=(this.subtotal-this.descuento)*.19;this.total=this.subtotal-this.descuento+this.iva;document.getElementById('subtotal-display').textContent=`$${this.subtotal.toFixed(2)}`;document.getElementById('descuento-display').textContent=`$${this.descuento.toFixed(2)}`;document.getElementById('iva-display').textContent=`$${this.iva.toFixed(2)}`;document.getElementById('total-display').textContent=`$${this.total.toFixed(2)}`}mostrarBusquedaProducto(){document.getElementById('producto-search')?.focus()}closeSearchResults(type){if(type){const results=document.getElementById(`${type}-search-results`);if(results)results.classList.remove('active')}else{document.querySelectorAll('.venta-search-results').forEach(r=>r.classList.remove('active'))}}submitForm(e){if(this.productos.length===0){e.preventDefault();this.showToast('Debe agregar al menos un producto','error');return}if(!this.cliente){e.preventDefault();this.showToast('Debe seleccionar un cliente','error');return}const metodoPago=document.querySelector('input[name="metodo_pago"]:checked');if(!metodoPago){e.preventDefault();this.showToast('Debe seleccionar un m\u00e9todo de pago','error');return}this.showLoading()}showToast(message,type='success',duration=3000){const toastId=`toast-${Date.now()}`;const toast=document.createElement('div');toast.className=`venta-toast ${type}`;toast.id=toastId;const icons={success:'\u2714\ufe0f',error:'\u274c',warning:'\u26a0\ufe0f',info:'\u2139\ufe0f'};toast.innerHTML=`
<span style="font-size:1.5rem;">${icons[type]||icons.info}</span>
<span>${message}</span>`;document.body.appendChild(toast);setTimeout(()=>toast.classList.add('active'),10);setTimeout(()=>{toast.classList.remove('active');setTimeout(()=>toast.remove(),300)},duration)}showLoading(){const overlay=document.createElement('div');overlay.className='venta-loading-overlay';overlay.id='venta-loading';overlay.innerHTML='<div class="venta-loading-spinner"></div><div class="venta-loading-text">Procesando venta...</div>';document.body.appendChild(overlay);setTimeout(()=>overlay.classList.add('active'),10)}hideLoading(){const overlay=document.getElementById('venta-loading');if(overlay){overlay.classList.remove('active');setTimeout(()=>overlay.remove(),300)}}}let nuevaVentaManager;document.addEventListener('DOMContentLoaded',()=>{nuevaVentaManager=new NuevaVentaManager()});
