class NotificacionesManager{constructor(){if(NotificacionesManager.instance)return NotificacionesManager.instance;NotificacionesManager.instance=this;this.init()}init(){this.setupEventListeners();this.initAnimations();this.setupEscapeKey()}setupEventListeners(){document.querySelectorAll('.notif-item').forEach((item,idx)=>{item.style.animationDelay=`${idx*0.05}s`;item.addEventListener('click',e=>{if(!e.target.closest('.notif-action-icon')){const id=item.dataset.id;if(id)this.verNotificacion(id)}})});document.querySelectorAll('[data-action="mark-read"]').forEach(btn=>{btn.addEventListener('click',e=>{e.stopPropagation();const id=btn.closest('.notif-item').dataset.id;this.marcarLeida(id)})});document.querySelectorAll('[data-action="delete"]').forEach(btn=>{btn.addEventListener('click',e=>{e.stopPropagation();const id=btn.closest('.notif-item').dataset.id;this.eliminarNotificacion(id)})});const markAllBtn=document.getElementById('markAllReadBtn');if(markAllBtn){markAllBtn.addEventListener('click',()=>this.marcarTodasLeidas())}const clearReadBtn=document.getElementById('clearReadBtn');if(clearReadBtn){clearReadBtn.addEventListener('click',()=>this.limpiarLeidas())}const filterForm=document.getElementById('filterForm');if(filterForm){filterForm.addEventListener('submit',e=>{e.preventDefault();this.aplicarFiltros()})}const filterInputs=document.querySelectorAll('.notif-filter-select');filterInputs.forEach(input=>{input.addEventListener('change',()=>this.aplicarFiltros())})}initAnimations(){const observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting){entry.target.classList.add('fade-in-up')}})},{threshold:0.1});document.querySelectorAll('.notif-stat-card, .notif-item').forEach(el=>{observer.observe(el)})}setupEscapeKey(){document.addEventListener('keydown',e=>{if(e.key==='Escape'){this.closeAllModals()}})}verNotificacion(id){window.location.href=`/vendedor/notificaciones/${id}`}marcarLeida(id){this.showLoading();fetch(`/vendedor/notificaciones/${id}/marcar-leida`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.json()).then(data=>{this.hideLoading();if(data.success){this.showToast('Notificación marcada como leída','success');const item=document.querySelector(`[data-id="${id}"]`);if(item){item.classList.remove('unread');const badge=item.querySelector('.notif-badge');if(badge)badge.remove()}this.actualizarContadores()}else{this.showToast(data.message||'Error al marcar como leída','danger')}}).catch(err=>{this.hideLoading();this.showToast('Error de conexión','danger');console.error(err)})}marcarTodasLeidas(){this.confirmAction('¿Marcar todas las notificaciones como leídas?',()=>{this.showLoading();fetch('/vendedor/notificaciones/marcar-todas-leidas',{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.json()).then(data=>{this.hideLoading();if(data.success){this.showToast('Todas las notificaciones marcadas como leídas','success');setTimeout(()=>location.reload(),1000)}else{this.showToast(data.message||'Error','danger')}}).catch(err=>{this.hideLoading();this.showToast('Error de conexión','danger');console.error(err)})},'Marcar todas como leídas')}eliminarNotificacion(id){this.confirmAction('¿Estás seguro de eliminar esta notificación?',()=>{this.showLoading();fetch(`/vendedor/notificaciones/${id}`,{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.json()).then(data=>{this.hideLoading();if(data.success){this.showToast('Notificación eliminada','success');const item=document.querySelector(`[data-id="${id}"]`);if(item){item.style.animation='fadeOut 0.3s';setTimeout(()=>item.remove(),300)}this.actualizarContadores()}else{this.showToast(data.message||'Error al eliminar','danger')}}).catch(err=>{this.hideLoading();this.showToast('Error de conexión','danger');console.error(err)})},'Eliminar notificación')}limpiarLeidas(){this.confirmAction('¿Eliminar todas las notificaciones leídas?',()=>{this.showLoading();fetch('/vendedor/notificaciones/limpiar-leidas',{method:'DELETE',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.json()).then(data=>{this.hideLoading();if(data.success){this.showToast(data.message,'success');setTimeout(()=>location.reload(),1000)}else{this.showToast(data.message||'Error','danger')}}).catch(err=>{this.hideLoading();this.showToast('Error de conexión','danger');console.error(err)})},'Limpiar notificaciones')}aplicarFiltros(){const form=document.getElementById('filterForm');if(form){form.submit()}}actualizarContadores(){fetch('/vendedor/notificaciones/contar-no-leidas',{headers:{'X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.json()).then(data=>{if(data.success){const badge=document.getElementById('notificationBadge');if(badge){badge.textContent=data.count;badge.style.display=data.count>0?'flex':'none'}}}).catch(err=>console.error(err))}showModal(modalId){const modal=document.getElementById(modalId);if(modal){modal.classList.add('active');document.body.style.overflow='hidden'}}closeModal(modal){if(modal){modal.classList.remove('active');document.body.style.overflow=''}}closeAllModals(){document.querySelectorAll('.notif-modal-backdrop').forEach(m=>this.closeModal(m))}confirmAction(message,onConfirm,title='Confirmar acción'){const backdrop=document.createElement('div');backdrop.className='notif-modal-backdrop active';backdrop.innerHTML=`<div class="notif-modal"><div class="notif-modal-header"><h3>${title}</h3><button class="notif-modal-close" onclick="notificacionesManager.closeAllModals()"><i class="bi bi-x"></i></button></div><div class="notif-modal-body"><p style="font-size:1rem;color:var(--gray-700)">${message}</p></div><div class="notif-modal-footer"><button class="notif-btn notif-btn-secondary" onclick="notificacionesManager.closeAllModals()">Cancelar</button><button class="notif-btn notif-btn-primary" id="confirmBtn">Confirmar</button></div></div>`;document.body.appendChild(backdrop);backdrop.querySelector('#confirmBtn').addEventListener('click',()=>{this.closeAllModals();backdrop.remove();onConfirm()});backdrop.addEventListener('click',e=>{if(e.target===backdrop){this.closeAllModals();backdrop.remove()}})}showToast(message,type='info'){const container=document.querySelector('.notif-toast-container')||this.createToastContainer();const toast=document.createElement('div');toast.className=`notif-toast ${type}`;const icons={success:'bi-check-circle-fill',danger:'bi-exclamation-circle-fill',warning:'bi-exclamation-triangle-fill',info:'bi-info-circle-fill'};toast.innerHTML=`<i class="bi ${icons[type]||icons.info} notif-toast-icon"></i><div class="notif-toast-content"><div class="notif-toast-message">${message}</div></div>`;container.appendChild(toast);setTimeout(()=>{toast.style.animation='slideInRight 0.3s reverse';setTimeout(()=>toast.remove(),300)},3000)}createToastContainer(){const container=document.createElement('div');container.className='notif-toast-container';document.body.appendChild(container);return container}showLoading(){let overlay=document.querySelector('.notif-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='notif-loading-overlay';overlay.innerHTML='<div class="notif-spinner"></div>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.querySelector('.notif-loading-overlay');if(overlay){overlay.classList.remove('active')}}}const notificacionesManager=new NotificacionesManager();
