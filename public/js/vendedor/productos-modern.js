/**
 * VENDEDOR - PRODUCTOS MODERN JS
 * Optimizado para PWA y Rendimiento
 */
class ProductosManager{constructor(){this.modalBackdrop=null;this.currentModal=null;this.toastContainer=null;this.loadingOverlay=null;this.init()}init(){this.createToastContainer();this.createLoadingOverlay();this.setupEventListeners();this.animateCards()}createToastContainer(){this.toastContainer=document.createElement('div');this.toastContainer.className='productos-toast-container';document.body.appendChild(this.toastContainer)}createLoadingOverlay(){this.loadingOverlay=document.createElement('div');this.loadingOverlay.className='productos-loading-overlay';this.loadingOverlay.innerHTML='<div><div class="productos-loading-spinner"></div><div class="productos-loading-text">Cargando...</div></div>';document.body.appendChild(this.loadingOverlay)}setupEventListeners(){document.addEventListener('DOMContentLoaded',()=>{this.setupFilterForm();this.setupCardClicks();this.setupImageGallery();this.setupModalClosers()});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.currentModal){this.closeModal()}})}setupFilterForm(){const form=document.getElementById('productos-filter-form');if(form){const inputs=form.querySelectorAll('input, select');inputs.forEach(input=>{if(input.type!=='submit'){input.addEventListener('change',()=>{form.submit()})}})}}setupCardClicks(){const cards=document.querySelectorAll('.productos-card');cards.forEach(card=>{card.addEventListener('click',(e)=>{if(!e.target.closest('.productos-action-btn')){const viewBtn=card.querySelector('.productos-action-btn-view');if(viewBtn){window.location.href=viewBtn.href}}})})}setupImageGallery(){const thumbs=document.querySelectorAll('.productos-show-thumb');const mainImage=document.querySelector('.productos-show-main-image');if(thumbs.length>0&&mainImage){thumbs.forEach(thumb=>{thumb.addEventListener('click',()=>{thumbs.forEach(t=>t.classList.remove('active'));thumb.classList.add('active');mainImage.src=thumb.dataset.full||thumb.src;mainImage.style.animation='none';setTimeout(()=>{mainImage.style.animation='scaleIn .3s ease'},10)})});if(thumbs[0]){thumbs[0].classList.add('active')}}}setupModalClosers(){document.addEventListener('click',(e)=>{if(e.target.classList.contains('productos-modal-backdrop')){this.closeModal()}if(e.target.classList.contains('productos-modal-close')){this.closeModal()}})}animateCards(){const cards=document.querySelectorAll('.productos-card');cards.forEach((card,index)=>{setTimeout(()=>{card.style.opacity='0';card.style.transform='translateY(20px)';card.style.animation='fadeInUp .5s ease forwards';card.style.animationDelay=`${index*.05}s`},50)})}showToast(message,type='info',title=''){const toast=document.createElement('div');toast.className=`productos-toast productos-toast-${type}`;const icons={success:'✅',error:'❌',warning:'⚠️',info:'ℹ️'};const icon=icons[type]||icons.info;const titleHtml=title?`<div class="productos-toast-title">${title}</div>`:'';toast.innerHTML=`
        <div class="productos-toast-icon">${icon}</div>
        <div class="productos-toast-content">
            ${titleHtml}
            <div class="productos-toast-message">${message}</div>
        </div>
        <button class="productos-toast-close" onclick="this.parentElement.remove()">×</button>
    `;this.toastContainer.appendChild(toast);setTimeout(()=>{toast.style.animation='slideInRight .3s ease reverse';setTimeout(()=>toast.remove(),300)},5000)}showLoading(text='Cargando...'){if(this.loadingOverlay){this.loadingOverlay.querySelector('.productos-loading-text').textContent=text;this.loadingOverlay.classList.add('active')}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.classList.remove('active')}}createModal(title,content,buttons=[],type='primary'){if(this.modalBackdrop){this.closeModal()}this.modalBackdrop=document.createElement('div');this.modalBackdrop.className='productos-modal-backdrop';const modal=document.createElement('div');modal.className='productos-modal';const headerClass=type==='primary'?'':'productos-modal-header-'+type;const buttonsHtml=buttons.map(btn=>`
            <button class="productos-modal-btn productos-modal-btn-${btn.type||'secondary'}" 
                    onclick="${btn.onclick||''}">
                ${btn.icon||''} ${btn.text}
            </button>
        `).join('');modal.innerHTML=`
        <div class="productos-modal-header ${headerClass}">
            <h3 class="productos-modal-title">${title}</h3>
            <button class="productos-modal-close">×</button>
        </div>
        <div class="productos-modal-body">${content}</div>
        ${buttons.length>0?`<div class="productos-modal-footer">${buttonsHtml}</div>`:''}
    `;this.modalBackdrop.appendChild(modal);document.body.appendChild(this.modalBackdrop);this.currentModal=modal;setTimeout(()=>{this.modalBackdrop.classList.add('active')},10);return modal}showModal(title,content,buttons=[],type='primary'){return this.createModal(title,content,buttons,type)}closeModal(){if(this.modalBackdrop){this.modalBackdrop.classList.remove('active');setTimeout(()=>{if(this.modalBackdrop){this.modalBackdrop.remove();this.modalBackdrop=null;this.currentModal=null}},300)}}confirmAction(title,message,onConfirm,onCancel=null){const modal=this.createModal(title,`<p style="font-size:1.1rem;color:var(--dark);line-height:1.6">${message}</p>`,[{text:'Cancelar',type:'secondary',onclick:'productosManager.closeModal();'+(onCancel?onCancel:'')},{text:'Confirmar',type:'primary',onclick:'productosManager.closeModal();'+(onConfirm||'')}],'warning');return modal}showProductDetail(productId){this.showLoading('Cargando detalles...');fetch(`/vendedor/productos/${productId}/detalle`).then(r=>r.json()).then(data=>{this.hideLoading();const content=`
                <div class="productos-modal-detail">
                    ${data.imagen?`<img src="${data.imagen}" alt="${data.nombre}" style="width:100%;border-radius:8px;margin-bottom:1rem">`:''}
                    <h4 style="margin-bottom:.5rem">${data.nombre}</h4>
                    <p style="color:var(--secondary);margin-bottom:1rem">${data.descripcion||'Sin descripción'}</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem;background:var(--light);border-radius:8px">
                        <div><strong>Precio:</strong><br><span style="font-size:1.5rem;color:var(--wine);font-weight:700">$${data.precio}</span></div>
                        <div><strong>Stock:</strong><br><span style="font-size:1.5rem;font-weight:700">${data.stock}</span></div>
                        <div><strong>Categoría:</strong><br>${data.categoria}</div>
                    </div>
                </div>
            `;this.showModal('Detalles del Producto',content,[{text:'Cerrar',type:'secondary',onclick:'productosManager.closeModal()'}])}).catch(err=>{this.hideLoading();this.showToast('Error al cargar detalles del producto','error','Error');console.error(err)})}}const productosManager=new ProductosManager();if(typeof window!=='undefined'){window.productosManager=productosManager}document.addEventListener('DOMContentLoaded',()=>{const filterInputs=document.querySelectorAll('.productos-filter-input');filterInputs.forEach(input=>{if(input.type==='search'){let debounceTimer;input.addEventListener('input',()=>{clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>{input.form.submit()},500)})}});const lazyImages=document.querySelectorAll('img[loading="lazy"]');if('IntersectionObserver'in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src||img.src;observer.unobserve(img)}})});lazyImages.forEach(img=>imageObserver.observe(img))}const urlParams=new URLSearchParams(window.location.search);const message=urlParams.get('message');const type=urlParams.get('type');if(message&&type){productosManager.showToast(decodeURIComponent(message),type)}});
