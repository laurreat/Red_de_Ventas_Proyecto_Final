class PerfilManager{constructor(){if(PerfilManager.instance)return PerfilManager.instance;PerfilManager.instance=this;this.init()}init(){this.setupEventListeners();this.initAnimations();this.initTabs();this.initAvatarUpload();this.initFormValidation();this.loadSwitchStates();this.initProgressAnimation();this.checkAutoSave()}setupEventListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape')this.closeAllModals()});document.querySelectorAll('.perfil-modal-backdrop').forEach(b=>{b.addEventListener('click',e=>{if(e.target===b)this.closeModal(b)})});document.querySelectorAll('.perfil-modal-close').forEach(btn=>{btn.addEventListener('click',()=>{this.closeModal(btn.closest('.perfil-modal-backdrop'))})})}initAnimations(){const observer=new IntersectionObserver(entries=>{entries.forEach((entry,idx)=>{if(entry.isIntersecting){setTimeout(()=>{entry.target.style.opacity='1'},idx*100)}})},{threshold:.1});document.querySelectorAll('.fade-in-up,.scale-in,.slide-in-right').forEach(el=>observer.observe(el))}initTabs(){const tabs=document.querySelectorAll('.perfil-tab');const contents=document.querySelectorAll('.perfil-tab-content');tabs.forEach(tab=>{tab.addEventListener('click',()=>{const targetId=tab.dataset.tab;tabs.forEach(t=>t.classList.remove('active'));contents.forEach(c=>c.classList.remove('active'));tab.classList.add('active');const target=document.getElementById(targetId);if(target){target.classList.add('active');localStorage.setItem('perfil_active_tab',targetId)}})});const saved=localStorage.getItem('perfil_active_tab');if(saved){const savedTab=document.querySelector(`[data-tab="${saved}"]`);if(savedTab)savedTab.click()}}initAvatarUpload(){const input=document.getElementById('avatarInput');const btn=document.getElementById('uploadAvatarBtn');if(btn&&input)btn.addEventListener('click',()=>input.click());if(input){input.addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;if(file.size>2097152){this.showToast('Archivo muy grande. Máximo 2MB','danger');return}if(!file.type.match('image.*')){this.showToast('Selecciona una imagen válida','danger');return}const reader=new FileReader();reader.onload=ev=>{const preview=document.querySelector('.perfil-avatar-preview img, .avatar-placeholder');if(preview){if(preview.tagName==='IMG'){preview.src=ev.target.result}else{const img=document.createElement('img');img.src=ev.target.result;img.className='perfil-avatar-large';preview.parentNode.replaceChild(img,preview)}}this.showToast('Avatar cargado. Guarda para aplicar','info')};reader.readAsDataURL(file)})}}initFormValidation(){document.querySelectorAll('.perfil-form').forEach(form=>{const inputs=form.querySelectorAll('.perfil-form-control');inputs.forEach(input=>{input.addEventListener('blur',()=>this.validateInput(input));input.addEventListener('input',()=>{if(input.classList.contains('error'))this.validateInput(input)})});form.addEventListener('submit',e=>{let valid=true;inputs.forEach(input=>{if(!this.validateInput(input))valid=false});if(!valid){e.preventDefault();this.showToast('Corrige los errores del formulario','warning')}});const debouncedSave=this.debounce(()=>this.autoSaveForm(form),2000);inputs.forEach(input=>{if(input.type!=='password')input.addEventListener('input',debouncedSave)})})}validateInput(input){const val=input.value.trim();const type=input.type;const req=input.hasAttribute('required');let valid=true;let error='';input.classList.remove('error');const existErr=input.parentNode.querySelector('.perfil-form-error');if(existErr)existErr.remove();if(req&&!val){valid=false;error='Campo requerido'}else if(val){if(type==='email'&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)){valid=false;error='Email inválido'}else if(input.name==='telefono'&&!/^[\d\s\-\+\(\)]{8,}$/.test(val)){valid=false;error='Teléfono inválido'}else if(input.name==='password'&&val.length<8){valid=false;error='Mínimo 8 caracteres'}else if(input.name==='password_confirmation'){const pwd=document.getElementById('password');if(pwd&&val!==pwd.value){valid=false;error='Contraseñas no coinciden'}}}if(!valid){input.classList.add('error');const div=document.createElement('div');div.className='perfil-form-error';div.innerHTML=`<i class="bi bi-exclamation-circle"></i> ${error}`;input.parentNode.appendChild(div)}return valid}showModal(modalId){const modal=document.getElementById(modalId);if(modal){modal.classList.add('active');document.body.style.overflow='hidden'}}closeModal(modal){if(modal){modal.classList.remove('active');document.body.style.overflow=''}else{document.querySelectorAll('.perfil-modal-backdrop.active').forEach(m=>m.classList.remove('active'));document.body.style.overflow=''}}closeAllModals(){this.closeModal()}showToast(msg,type='info',title=''){const container=document.querySelector('.perfil-toast-container')||this.createToastContainer();const icons={success:'bi-check-circle-fill',warning:'bi-exclamation-triangle-fill',danger:'bi-x-circle-fill',info:'bi-info-circle-fill'};const titles={success:'Éxito',warning:'Advertencia',danger:'Error',info:'Información'};const toast=document.createElement('div');toast.className=`perfil-toast ${type}`;toast.innerHTML=`<i class="bi ${icons[type]}"></i><span>${msg}</span>`;container.appendChild(toast);setTimeout(()=>this.closeToast(toast),4000)}closeToast(toast){if(toast){toast.style.opacity='0';setTimeout(()=>toast.remove(),300)}}createToastContainer(){const c=document.createElement('div');c.className='perfil-toast-container';document.body.appendChild(c);return c}showLoading(txt='Cargando...'){let overlay=document.querySelector('.perfil-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='perfil-loading-overlay';overlay.innerHTML=`<div class="perfil-loading-spinner"></div><div style="margin-top:1rem;color:var(--gray-700);font-weight:600">${txt}</div>`;document.body.appendChild(overlay)}overlay.classList.add('active');document.body.style.overflow='hidden'}hideLoading(){const overlay=document.querySelector('.perfil-loading-overlay');if(overlay){overlay.classList.remove('active');document.body.style.overflow=''}}loadSwitchStates(){document.querySelectorAll('.perfil-switch input[type="checkbox"]').forEach(sw=>{const saved=localStorage.getItem(`perfil_switch_${sw.id}`);if(saved!==null)sw.checked=saved==='true'})}checkAutoSave(){const saved=localStorage.getItem('perfil_autosave');if(saved){this.confirmAction('¿Recuperar cambios sin guardar?',()=>{const data=JSON.parse(saved);Object.keys(data).forEach(key=>{const input=document.querySelector(`[name="${key}"]`);if(input)input.value=data[key]});localStorage.removeItem('perfil_autosave');this.showToast('Datos recuperados','success')},'Recuperar datos')}}autoSaveForm(form){const data={};form.querySelectorAll('input,textarea,select').forEach(input=>{if(input.name&&input.type!=='password')data[input.name]=input.value});localStorage.setItem('perfil_autosave',JSON.stringify(data))}initProgressAnimation(){document.querySelectorAll('.perfil-progress-fill').forEach(bar=>{const target=bar.dataset.progress||'0';bar.style.width='0';setTimeout(()=>bar.style.width=target+'%',100)})}debounce(fn,wait){let timeout;return function(...args){clearTimeout(timeout);timeout=setTimeout(()=>fn(...args),wait)}}copyToClipboard(txt){navigator.clipboard.writeText(txt).then(()=>this.showToast('Copiado al portapapeles','success')).catch(()=>this.showToast('Error al copiar','danger'))}exportData(){this.showLoading('Exportando...');fetch('/vendedor/perfil/exportar',{headers:{'X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]').content}}).then(r=>r.blob()).then(blob=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mis_datos_vendedor.json';a.click();this.hideLoading();this.showToast('Datos exportados','success')}).catch(()=>{this.hideLoading();this.showToast('Error al exportar','danger')})}refreshStats(){this.showLoading('Actualizando...');location.reload()}confirmAction(msg,onConfirm,title='Confirmar'){const id='confirm-modal-temp';let modal=document.getElementById(id);if(!modal){modal=document.createElement('div');modal.id=id;modal.className='perfil-modal-backdrop';modal.innerHTML=`<div class="perfil-modal"><div class="perfil-modal-header"><h3>${title}</h3><button class="perfil-modal-close" onclick="perfilManager.closeModal(this.closest('.perfil-modal-backdrop'))"><i class="bi bi-x"></i></button></div><div class="perfil-modal-body"><p>${msg}</p></div><div class="perfil-modal-footer"><button class="perfil-btn perfil-btn-secondary" onclick="perfilManager.closeModal(this.closest('.perfil-modal-backdrop'))">Cancelar</button><button class="perfil-btn perfil-btn-primary" id="confirmBtn">Confirmar</button></div></div>`;document.body.appendChild(modal);modal.querySelector('#confirmBtn').addEventListener('click',()=>{onConfirm();this.closeModal(modal)})}this.showModal(id)}}const perfilManager=new PerfilManager();document.addEventListener('DOMContentLoaded',()=>{const refreshBtn=document.getElementById('refreshStatsBtn');if(refreshBtn)refreshBtn.addEventListener('click',()=>perfilManager.refreshStats());const exportBtn=document.getElementById('exportDataBtn');if(exportBtn)exportBtn.addEventListener('click',()=>perfilManager.exportData());document.querySelectorAll('.perfil-switch input[type="checkbox"]').forEach(sw=>{sw.addEventListener('change',e=>{localStorage.setItem(`perfil_switch_${sw.id}`,e.target.checked);perfilManager.showToast('Preferencia actualizada','success')})})});if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.ready.then(()=>console.log('PWA Ready'))})}
