/**
 * VENDEDOR - COMISIONES MODERN JS
 * Optimizado para PWA y Rendimiento
 */
class ComisionesManager{constructor(){this.modalBackdrop=null;this.currentModal=null;this.toastContainer=null;this.loadingOverlay=null;this.init()}init(){this.createToastContainer();this.createLoadingOverlay();this.setupEventListeners();this.animateElements()}createToastContainer(){this.toastContainer=document.createElement('div');this.toastContainer.className='comisiones-toast-container';document.body.appendChild(this.toastContainer)}createLoadingOverlay(){this.loadingOverlay=document.createElement('div');this.loadingOverlay.className='comisiones-loading-overlay';this.loadingOverlay.innerHTML='<div><div class="comisiones-loading-spinner"></div><div class="comisiones-loading-text">Cargando...</div></div>';document.body.appendChild(this.loadingOverlay)}setupEventListeners(){document.addEventListener('DOMContentLoaded',()=>{this.setupFilterForm();this.setupTableRows();this.setupModalClosers();this.checkUrlMessages()});document.addEventListener('keydown',(e)=>{if(e.key==='Escape'&&this.currentModal){this.closeModal()}})}setupFilterForm(){const form=document.getElementById('comisiones-filter-form');if(form){const inputs=form.querySelectorAll('input, select');inputs.forEach(input=>{if(input.type!=='submit'){input.addEventListener('change',()=>{form.submit()})}})}}setupTableRows(){const rows=document.querySelectorAll('.comisiones-table tbody tr');rows.forEach((row,index)=>{setTimeout(()=>{row.style.opacity='0';row.style.transform='translateY(20px)';row.style.animation='fadeInUp .5s ease forwards';row.style.animationDelay=`${index*.03}s`},50)})}setupModalClosers(){document.addEventListener('click',(e)=>{if(e.target.classList.contains('comisiones-modal-backdrop')){this.closeModal()}if(e.target.classList.contains('comisiones-modal-close')){this.closeModal()}})}animateElements(){const cards=document.querySelectorAll('.comisiones-stat-card,.comisiones-card');cards.forEach((card,index)=>{setTimeout(()=>{card.style.opacity='0';card.style.transform='translateY(20px)';card.style.animation='fadeInUp .5s ease forwards';card.style.animationDelay=`${index*.05}s`},50)})}showToast(message,type='info',title=''){const toast=document.createElement('div');toast.className=`comisiones-toast comisiones-toast-${type}`;const icons={success:'✅',error:'❌',warning:'⚠️',info:'ℹ️'};const icon=icons[type]||icons.info;const titleHtml=title?`<div class="comisiones-toast-title">${title}</div>`:'';toast.innerHTML=`
        <div class="comisiones-toast-icon">${icon}</div>
        <div class="comisiones-toast-content">
            ${titleHtml}
            <div class="comisiones-toast-message">${message}</div>
        </div>
        <button class="comisiones-toast-close" onclick="this.parentElement.remove()">×</button>
    `;this.toastContainer.appendChild(toast);setTimeout(()=>{toast.style.animation='slideInRight .3s ease reverse';setTimeout(()=>toast.remove(),300)},5000)}showLoading(text='Cargando...'){if(this.loadingOverlay){this.loadingOverlay.querySelector('.comisiones-loading-text').textContent=text;this.loadingOverlay.classList.add('active')}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.classList.remove('active')}}createModal(title,content,buttons=[],type='primary'){if(this.modalBackdrop){this.closeModal()}this.modalBackdrop=document.createElement('div');this.modalBackdrop.className='comisiones-modal-backdrop';const modal=document.createElement('div');modal.className='comisiones-modal';const buttonsHtml=buttons.map(btn=>`
            <button class="comisiones-modal-btn comisiones-modal-btn-${btn.type||'secondary'}" 
                    onclick="${btn.onclick||''}">
                ${btn.icon||''} ${btn.text}
            </button>
        `).join('');modal.innerHTML=`
        <div class="comisiones-modal-header">
            <h3 class="comisiones-modal-title">${title}</h3>
            <button class="comisiones-modal-close">×</button>
        </div>
        <div class="comisiones-modal-body">${content}</div>
        ${buttons.length>0?`<div class="comisiones-modal-footer">${buttonsHtml}</div>`:''}
    `;this.modalBackdrop.appendChild(modal);document.body.appendChild(this.modalBackdrop);this.currentModal=modal;setTimeout(()=>{this.modalBackdrop.classList.add('active')},10);return modal}showModal(title,content,buttons=[],type='primary'){return this.createModal(title,content,buttons,type)}closeModal(){if(this.modalBackdrop){this.modalBackdrop.classList.remove('active');setTimeout(()=>{if(this.modalBackdrop){this.modalBackdrop.remove();this.modalBackdrop=null;this.currentModal=null}},300)}}confirmAction(title,message,onConfirm,onCancel=null){const modal=this.createModal(title,`<p style="font-size:1.1rem;color:var(--dark);line-height:1.6">${message}</p>`,[{text:'Cancelar',type:'secondary',onclick:'comisionesManager.closeModal();'+(onCancel?onCancel:'')},{text:'Confirmar',type:'primary',onclick:'comisionesManager.closeModal();'+(onConfirm||'')}],'warning');return modal}showComisionDetail(comisionId){this.showLoading('Cargando detalles...');fetch(`/vendedor/comisiones/${comisionId}/detalle`).then(r=>r.json()).then(data=>{this.hideLoading();const content=`
                <div class="comisiones-modal-detail">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem;background:var(--light);border-radius:8px;margin-bottom:1rem">
                        <div><strong>Monto:</strong><br><span style="font-size:1.5rem;color:var(--wine);font-weight:700">$${data.monto}</span></div>
                        <div><strong>Estado:</strong><br><span class="comisiones-badge comisiones-badge-${data.estado}">${data.estado}</span></div>
                        <div><strong>Tipo:</strong><br>${data.tipo}</div>
                        <div><strong>Fecha:</strong><br>${data.fecha}</div>
                    </div>
                    ${data.descripcion?`<p style="color:var(--secondary);margin-top:1rem">${data.descripcion}</p>`:''}
                </div>
            `;this.showModal('Detalles de Comisión',content,[{text:'Cerrar',type:'secondary',onclick:'comisionesManager.closeModal()'}])}).catch(err=>{this.hideLoading();this.showToast('Error al cargar detalles de la comisión','error','Error');console.error(err)})}checkUrlMessages(){const urlParams=new URLSearchParams(window.location.search);const message=urlParams.get('message');const type=urlParams.get('type');if(message&&type){this.showToast(decodeURIComponent(message),type)}}formatMoney(amount){return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0,maximumFractionDigits:0}).format(amount)}validateSolicitudForm(){const form=document.getElementById('solicitud-retiro-form');if(!form)return true;const monto=parseFloat(form.querySelector('[name="monto"]').value);const metodoPago=form.querySelector('[name="metodo_pago"]').value;const datosPago=form.querySelector('[name="datos_pago"]').value;if(isNaN(monto)||monto<50000){this.showToast('El monto mínimo de retiro es $50,000 COP','warning','Monto inválido');return false}if(!metodoPago){this.showToast('Selecciona un método de pago','warning','Método requerido');return false}if(!datosPago||datosPago.trim().length<5){this.showToast('Proporciona los datos de pago completos','warning','Datos incompletos');return false}return true}}const comisionesManager=new ComisionesManager();if(typeof window!=='undefined'){window.comisionesManager=comisionesManager}document.addEventListener('DOMContentLoaded',()=>{const filterInputs=document.querySelectorAll('.comisiones-filter-input');filterInputs.forEach(input=>{if(input.type==='search'||input.type==='text'){let debounceTimer;input.addEventListener('input',()=>{clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>{if(input.form){input.form.submit()}},500)})}});const solicitudForm=document.getElementById('solicitud-retiro-form');if(solicitudForm){solicitudForm.addEventListener('submit',(e)=>{if(!comisionesManager.validateSolicitudForm()){e.preventDefault()}})}const statCards=document.querySelectorAll('.comisiones-stat-card');statCards.forEach(card=>{card.addEventListener('click',()=>{const filter=card.dataset.filter;if(filter){const filterForm=document.getElementById('comisiones-filter-form');if(filterForm){const estadoSelect=filterForm.querySelector('[name="estado"]');if(estadoSelect){estadoSelect.value=filter;filterForm.submit()}}}})})});
