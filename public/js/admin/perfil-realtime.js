/**
 * Admin Perfil Real-Time Manager v2.0
 * Gestión de perfil con actualizaciones en tiempo real
 */
class AdminPerfilManager{constructor(){this.statsInterval=30000;this.activityInterval=20000;this.notifInterval=15000;this.statsTimer=null;this.activityTimer=null;this.notifTimer=null;this.isUpdating=false;this.init()}init(){this.initRealTimeUpdates();this.initEventListeners();this.initToasts();this.initVisibilityHandler();console.log('Admin Perfil Manager initialized with real-time')}initRealTimeUpdates(){this.startRealTime();document.addEventListener('visibilitychange',()=>{if(document.hidden){this.stopRealTime()}else{this.startRealTime()}})}startRealTime(){this.updateStats();this.updateActivity();this.checkNotifications();this.statsTimer=setInterval(()=>this.updateStats(),this.statsInterval);this.activityTimer=setInterval(()=>this.updateActivity(),this.activityInterval);this.notifTimer=setInterval(()=>this.checkNotifications(),this.notifInterval);console.log('Real-time updates started')}stopRealTime(){if(this.statsTimer){clearInterval(this.statsTimer);this.statsTimer=null}if(this.activityTimer){clearInterval(this.activityTimer);this.activityTimer=null}if(this.notifTimer){clearInterval(this.notifTimer);this.notifTimer=null}console.log('Real-time updates stopped')}async updateStats(){if(this.isUpdating)return;this.isUpdating=true;try{const response=await fetch('/admin/perfil/stats-realtime',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)throw new Error('Failed to fetch stats');const data=await response.json();this.renderStats(data.stats);this.showUpdateIndicator()}catch(error){console.error('Error updating stats:',error)}finally{this.isUpdating=false}}renderStats(stats){if(stats.pedidos_cliente!==undefined){this.updateStatValue('pedidos-cliente',stats.pedidos_cliente)}if(stats.pedidos_vendedor!==undefined){this.updateStatValue('pedidos-vendedor',stats.pedidos_vendedor)}if(stats.total_referidos!==undefined){this.updateStatValue('total-referidos',stats.total_referidos)}if(stats.ventas_total!==undefined){this.updateStatValue('ventas-total','$'+this.formatNumber(stats.ventas_total))}if(stats.comisiones_total!==undefined){this.updateStatValue('comisiones-total','$'+this.formatNumber(stats.comisiones_total))}}updateStatValue(id,value){const element=document.querySelector(`[data-stat="${id}"]`);if(element){const currentValue=element.textContent.trim();if(currentValue!==value.toString()){element.textContent=value;element.classList.add('perfil-stat-update');setTimeout(()=>element.classList.remove('perfil-stat-update'),600)}}}async updateActivity(){try{const response=await fetch('/admin/perfil/activity-realtime',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)return;const data=await response.json();this.renderActivity(data.actividad)}catch(error){console.error('Error updating activity:',error)}}renderActivity(actividades){const container=document.getElementById('actividad-realtime');if(!container)return;if(actividades.length===0){container.innerHTML=`<div class="text-center py-4"><i class="bi bi-activity fs-1 text-muted"></i><p class="text-muted mt-2">No hay actividad reciente</p></div>`;return}const html=actividades.slice(0,10).map((act,index)=>`<div class="perfil-activity-item" style="animation-delay:${index*0.05}s"><div class="perfil-activity-icon" style="background:linear-gradient(135deg,${this.getActivityColor(act.tipo)})"><i class="bi bi-${this.getActivityIcon(act.tipo)} text-white"></i></div><div class="flex-grow-1 ms-3"><p class="mb-1 fw-semibold">${act.descripcion}</p><small class="text-muted">${act.tiempo}${act.monto?' • $'+this.formatNumber(act.monto):''}</small></div></div>`).join('');container.innerHTML=html}async checkNotifications(){try{const response=await fetch('/admin/perfil/notificaciones-nuevas',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)return;const data=await response.json();if(data.notificaciones&&data.notificaciones.length>0){this.updateNotifBadge(data.count);data.notificaciones.forEach(notif=>{this.showToast(notif.mensaje,notif.tipo||'info',5000)})}}catch(error){console.error('Error checking notifications:',error)}}updateNotifBadge(count){let badge=document.querySelector('.perfil-notif-badge');const bellIcon=document.querySelector('[data-notif-indicator]');if(count>0){if(!badge&&bellIcon){badge=document.createElement('span');badge.className='perfil-notif-badge';bellIcon.style.position='relative';bellIcon.appendChild(badge)}if(badge){badge.textContent=count>99?'99+':count}}else{badge?.remove()}}initToasts(){this.toastContainer=document.createElement('div');this.toastContainer.className='perfil-toast-container';this.toastContainer.style.cssText='position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none';document.body.appendChild(this.toastContainer)}showToast(message,type='success',duration=3000){const toast=document.createElement('div');toast.className=`perfil-toast ${type}`;toast.style.pointerEvents='all';const icon=this.getToastIcon(type);toast.innerHTML=`<i class="bi bi-${icon}"></i><span>${message}</span>`;this.toastContainer.appendChild(toast);setTimeout(()=>{toast.style.opacity='0';setTimeout(()=>toast.remove(),300)},duration)}getToastIcon(type){const icons={success:'check-circle-fill',error:'x-circle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};return icons[type]||icons.info}showLoading(){let overlay=document.querySelector('.perfil-loading');if(!overlay){overlay=document.createElement('div');overlay.className='perfil-loading';overlay.innerHTML='<div class="perfil-spinner"></div>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.querySelector('.perfil-loading');if(overlay){overlay.classList.remove('active')}}showUpdateIndicator(){let indicator=document.querySelector('.perfil-update-badge');if(!indicator){indicator=document.createElement('span');indicator.className='perfil-update-badge';indicator.textContent='Actualizado';const statsCard=document.querySelector('.stats-card');if(statsCard){statsCard.style.position='relative';statsCard.appendChild(indicator)}}setTimeout(()=>indicator?.remove(),3000)}initEventListeners(){document.querySelectorAll('[data-action="refresh"]').forEach(btn=>{btn.addEventListener('click',()=>{this.showLoading();this.updateStats();this.updateActivity();setTimeout(()=>{this.hideLoading();this.showToast('Datos actualizados correctamente','success')},1000)})});const activityBtn=document.getElementById('ver-actividad-btn');if(activityBtn){activityBtn.addEventListener('click',()=>this.loadFullActivity())}}async loadFullActivity(){this.showLoading();try{const response=await fetch('/admin/perfil/activity',{headers:{'X-Requested-With':'XMLHttpRequest','Accept':'application/json'}});if(!response.ok)throw new Error('Failed to load activity');const data=await response.json();this.displayActivityModal(data.data)}catch(error){console.error('Error loading activity:',error);this.showToast('Error al cargar actividad','error')}finally{this.hideLoading()}}displayActivityModal(data){const modal=document.getElementById('activityModal');const content=document.getElementById('activityContent');if(!modal||!content)return;let html='<div class="row">';if(data.pedidos&&data.pedidos.length>0){html+=`<div class="col-md-6 mb-4"><h5 class="text-wine mb-3"><i class="bi bi-cart-check me-2"></i>Pedidos Recientes</h5>`;data.pedidos.forEach(pedido=>{const badgeColor=pedido.estado==='entregado'?'success':pedido.estado==='cancelado'?'danger':'warning';html+=`<div class="activity-item"><div class="d-flex justify-content-between"><div><strong>${pedido.numero_pedido}</strong><br><span class="badge bg-${badgeColor} activity-badge">${pedido.estado}</span><small class="text-muted ms-2">$${this.formatNumber(pedido.total_final)}</small></div><small class="text-muted">${new Date(pedido.created_at).toLocaleDateString()}</small></div></div>`});html+='</div>'}if(data.usuarios_referidos&&data.usuarios_referidos.length>0){html+=`<div class="col-md-6 mb-4"><h5 class="text-wine mb-3"><i class="bi bi-people me-2"></i>Referidos Recientes</h5>`;data.usuarios_referidos.forEach(user=>{const roleColors={administrador:'success',lider:'info',vendedor:'warning',cliente:'secondary'};const roleColor=roleColors[user.rol]||'secondary';html+=`<div class="activity-item"><div class="d-flex justify-content-between"><div><strong>${user.name} ${user.apellidos||''}</strong><br><span class="badge bg-${roleColor} activity-badge">${user.rol}</span><span class="badge bg-${user.activo?'success':'danger'} activity-badge ms-1">${user.activo?'Activo':'Inactivo'}</span></div><small class="text-muted">${new Date(user.created_at).toLocaleDateString()}</small></div></div>`});html+='</div>'}if(data.resumen){html+=`<div class="col-12"><div class="perfil-data-section"><h5 class="text-wine mb-3"><i class="bi bi-graph-up me-2"></i>Resumen de Actividad</h5><div class="row"><div class="col-md-3"><div class="stats-card"><div class="stats-number">${data.resumen.pedidos_como_cliente}</div><div class="stats-label">Pedidos Cliente</div></div></div><div class="col-md-3"><div class="stats-card"><div class="stats-number">${data.resumen.pedidos_como_vendedor}</div><div class="stats-label">Pedidos Vendedor</div></div></div><div class="col-md-3"><div class="stats-card"><div class="stats-number">${data.resumen.total_referidos}</div><div class="stats-label">Referidos</div></div></div><div class="col-md-3"><div class="stats-card"><div class="stats-number">${data.resumen.accesos_ultimo_mes}</div><div class="stats-label">Accesos/Mes</div></div></div></div></div></div>`}html+='</div>';content.innerHTML=html;const bsModal=new bootstrap.Modal(modal);bsModal.show()}initVisibilityHandler(){document.addEventListener('visibilitychange',()=>{if(!document.hidden){this.updateStats();this.updateActivity()}})}getActivityColor(tipo){const colors={pedido:'var(--wine), var(--wine-light)',usuario:'var(--success), #059669',comision:'var(--warning), #d97706',sistema:'var(--info), #2563eb'};return colors[tipo]||colors.sistema}getActivityIcon(tipo){const icons={pedido:'cart-check',usuario:'person-plus',comision:'currency-dollar',sistema:'info-circle'};return icons[tipo]||'clock-history'}formatNumber(value){return new Intl.NumberFormat('es-CO').format(value)}destroy(){this.stopRealTime();this.toastContainer?.remove();console.log('Admin Perfil Manager destroyed')}}let adminPerfilManager;document.addEventListener('DOMContentLoaded',()=>{adminPerfilManager=new AdminPerfilManager()});window.addEventListener('beforeunload',()=>{adminPerfilManager?.destroy()});
