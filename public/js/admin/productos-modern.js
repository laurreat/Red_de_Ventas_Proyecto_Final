/**
 * Gestión de Productos - JavaScript Interactivo
 * Modales profesionales, animaciones, validaciones y preview de imágenes
 * Versión: 3.0 - Optimizado para carga <3s
 */

class ProductsManager{constructor(){this.currentModal=null;this.imagePreview=null;this.init()}init(){this.setupEventListeners();this.setupTableAnimations();this.setupImagePreview();this.setupFormValidation();console.log('✅ Products Manager v3.0 initialized')}setupEventListeners(){document.querySelectorAll('[data-action="toggle-status"]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const productId=btn.dataset.productId;const isActive=btn.dataset.active==='true';const productName=btn.dataset.productName;this.showToggleModal(productId,isActive,productName)})});document.querySelectorAll('[data-action="delete-product"]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const productId=btn.dataset.productId;const productName=btn.dataset.productName;const productImage=btn.dataset.productImage;this.showDeleteModal(productId,productName,productImage)})});document.addEventListener('keydown',e=>{if(e.key==='Escape'&&this.currentModal){this.closeModal()}});document.querySelectorAll('.product-stat-card').forEach(card=>{card.addEventListener('mouseenter',()=>{card.style.transform='translateY(-4px)'});card.addEventListener('mouseleave',()=>{card.style.transform='translateY(0)'})})}setupTableAnimations(){const rows=document.querySelectorAll('.products-table tbody tr');rows.forEach((row,index)=>{row.style.opacity='0';row.style.animation=`fadeInUp 0.3s ease-out ${index*.05}s forwards`})}setupImagePreview(){const fileInputs=document.querySelectorAll('input[type="file"][name="imagen"]');fileInputs.forEach(input=>{input.addEventListener('change',e=>this.handleImagePreview(e));const dropArea=input.closest('.product-upload-area');if(dropArea){this.setupDragAndDrop(dropArea,input)}})}setupDragAndDrop(dropArea,input){['dragenter','dragover','dragleave','drop'].forEach(eventName=>{dropArea.addEventListener(eventName,e=>{e.preventDefault();e.stopPropagation()})});['dragenter','dragover'].forEach(eventName=>{dropArea.addEventListener(eventName,()=>dropArea.classList.add('drag-over'))});['dragleave','drop'].forEach(eventName=>{dropArea.addEventListener(eventName,()=>dropArea.classList.remove('drag-over'))});dropArea.addEventListener('drop',e=>{const files=e.dataTransfer.files;if(files.length>0){input.files=files;this.handleImagePreview({target:input})}})}handleImagePreview(event){const file=event.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){this.showToast('Por favor selecciona una imagen válida','error');return}const maxSize=2*1024*1024;if(file.size>maxSize){this.showToast('La imagen no debe superar 2MB','error');event.target.value='';return}const preview=document.getElementById('preview');const imagePreview=document.getElementById('imagePreview');const placeholder=document.getElementById('placeholderImage');if(preview&&imagePreview){const reader=new FileReader();reader.onload=e=>{preview.src=e.target.result;imagePreview.style.display='block';if(placeholder)placeholder.style.display='none'};reader.readAsDataURL(file)}this.showToast('Imagen cargada correctamente','success')}setupFormValidation(){const forms=document.querySelectorAll('#createProductForm, #editProductForm');forms.forEach(form=>{const nameInput=form.querySelector('[name="nombre"]');const priceInput=form.querySelector('[name="precio"]');const stockInput=form.querySelector('[name="stock"]');const categorySelect=form.querySelector('[name="categoria_id"]');if(nameInput){nameInput.addEventListener('input',()=>this.validateField(nameInput,val=>val.length>=3,'El nombre debe tener al menos 3 caracteres'))}if(priceInput){priceInput.addEventListener('input',()=>this.validateField(priceInput,val=>parseFloat(val)>0,'El precio debe ser mayor a 0'))}if(stockInput){stockInput.addEventListener('input',()=>this.validateField(stockInput,val=>parseInt(val)>=0,'El stock no puede ser negativo'))}if(categorySelect){categorySelect.addEventListener('change',()=>this.validateField(categorySelect,val=>val!=='','Selecciona una categoría'))}form.addEventListener('submit',e=>{let isValid=true;[nameInput,priceInput,stockInput,categorySelect].forEach(field=>{if(field&&!this.isFieldValid(field)){isValid=false;field.classList.add('is-invalid')}});if(!isValid){e.preventDefault();this.showToast('Por favor corrige los errores del formulario','error')}})})}validateField(field,validator,errorMsg){const value=field.value.trim();const isValid=validator(value);if(isValid){field.classList.remove('is-invalid');field.classList.add('is-valid');this.removeError(field)}else{field.classList.remove('is-valid');field.classList.add('is-invalid');this.showError(field,errorMsg)}return isValid}isFieldValid(field){return field.classList.contains('is-valid')||(field.value.trim()!==''&&!field.classList.contains('is-invalid'))}showError(field,message){this.removeError(field);const error=document.createElement('div');error.className='invalid-feedback';error.textContent=message;error.style.display='block';field.parentNode.appendChild(error)}removeError(field){const error=field.parentNode.querySelector('.invalid-feedback');if(error)error.remove()}showToggleModal(productId,isActive,productName){const action=isActive?'desactivar':'activar';const actionCap=isActive?'Desactivar':'Activar';const type=isActive?'warning':'success';const icon=isActive?'pause':'play';const modal=this.createModal({title:`${actionCap} Producto`,icon:`${icon}-fill`,type:type,message:`¿Estás seguro que deseas ${action} el producto <strong>${productName}</strong>?<br><small class="text-muted">El producto ${isActive?'no será visible':'será visible'} en el catálogo.</small>`,confirmText:actionCap,cancelText:'Cancelar',onConfirm:()=>{this.toggleStatus(productId)}});this.showModal(modal)}toggleStatus(productId){this.showLoading();const form=document.getElementById(`toggle-form-${productId}`);if(form){form.submit()}}showDeleteModal(productId,productName,productImage){const modal=this.createModal({title:'Eliminar Producto',icon:'trash',type:'danger',message:`<div style="text-align:center;margin-bottom:1rem;"><img src="${productImage||'/images/placeholder.png'}" alt="${productName}" style="width:80px;height:80px;border-radius:12px;object-fit:cover;box-shadow:0 4px 6px rgba(0,0,0,0.1);"/></div>¿Estás seguro que deseas eliminar el producto <strong>${productName}</strong>?<br><br><small class="text-muted">Esta acción no se puede deshacer. El producto será eliminado permanentemente del sistema.</small>`,confirmText:'Sí, eliminar',cancelText:'Cancelar',onConfirm:()=>{this.deleteProduct(productId)}});this.showModal(modal)}deleteProduct(productId){this.showLoading();const form=document.getElementById(`delete-form-${productId}`);if(form){form.submit()}}createModal(options){const{title='Confirmación',icon='question-circle',type='primary',message='¿Estás seguro?',confirmText='Confirmar',cancelText='Cancelar',onConfirm=()=>{},onCancel=()=>{}}=options;const colors={primary:{bg:'rgba(114,47,55,0.1)',color:'#722F37'},success:{bg:'rgba(16,185,129,0.1)',color:'#10b981'},warning:{bg:'rgba(245,158,11,0.1)',color:'#f59e0b'},danger:{bg:'rgba(239,68,68,0.1)',color:'#ef4444'},info:{bg:'rgba(59,130,246,0.1)',color:'#3b82f6'}};const color=colors[type]||colors.primary;const modalHTML=`<div class="product-modal-backdrop"></div><div class="product-modal"><div class="product-modal-content"><div class="product-modal-header"><div class="product-modal-title"><div class="product-modal-icon" style="background:${color.bg};color:${color.color};"><i class="bi bi-${icon}"></i></div><span>${title}</span></div><button class="product-modal-close" data-action="cancel"><i class="bi bi-x-lg"></i></button></div><div class="product-modal-body">${message}</div><div class="product-modal-footer"><button class="product-modal-btn product-modal-btn-secondary" data-action="cancel">${cancelText}</button><button class="product-modal-btn product-modal-btn-${type}" data-action="confirm"><i class="bi bi-${icon}"></i>${confirmText}</button></div></div></div>`;const container=document.createElement('div');container.innerHTML=modalHTML;container.querySelectorAll('[data-action="confirm"]').forEach(btn=>{btn.addEventListener('click',()=>{onConfirm();this.closeModal()})});container.querySelectorAll('[data-action="cancel"]').forEach(btn=>{btn.addEventListener('click',()=>{onCancel();this.closeModal()})});container.querySelector('.product-modal-backdrop').addEventListener('click',()=>{onCancel();this.closeModal()});return container}showModal(modalContainer){this.closeModal();document.body.appendChild(modalContainer);this.currentModal=modalContainer;requestAnimationFrame(()=>{modalContainer.querySelector('.product-modal-backdrop').classList.add('active');modalContainer.querySelector('.product-modal').classList.add('active')})}closeModal(){if(!this.currentModal)return;const backdrop=this.currentModal.querySelector('.product-modal-backdrop');const modal=this.currentModal.querySelector('.product-modal');if(backdrop)backdrop.classList.remove('active');if(modal)modal.classList.remove('active');setTimeout(()=>{if(this.currentModal){this.currentModal.remove();this.currentModal=null}},300)}showToast(message,type='info'){const icons={success:'check-circle-fill',error:'x-circle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};const toast=document.createElement('div');toast.className=`product-toast ${type}`;toast.innerHTML=`<i class="bi bi-${icons[type]}"></i><span>${message}</span>`;document.body.appendChild(toast);setTimeout(()=>{toast.style.animation='fadeOut 0.3s ease-out';setTimeout(()=>toast.remove(),300)},3000)}showLoading(){let overlay=document.querySelector('.product-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.className='product-loading-overlay';overlay.innerHTML='<div class="product-loading-spinner"></div>';document.body.appendChild(overlay)}overlay.classList.add('active')}hideLoading(){const overlay=document.querySelector('.product-loading-overlay');if(overlay){overlay.classList.remove('active')}}}function toggleStatus(productId){const row=document.querySelector(`tr[data-product-id="${productId}"]`);if(!row)return;const statusBadge=row.querySelector('.product-badge-active, .product-badge-inactive');const nameElement=row.querySelector('.product-name');const isActive=statusBadge&&statusBadge.classList.contains('product-badge-active');const productName=nameElement?nameElement.textContent.trim():'Producto';if(window.productsManager){window.productsManager.showToggleModal(productId,isActive,productName)}}function confirmDelete(productId){const row=document.querySelector(`tr[data-product-id="${productId}"]`);if(!row)return;const nameElement=row.querySelector('.product-name');const imageElement=row.querySelector('.product-image');const productName=nameElement?nameElement.textContent.trim():'Producto';const productImage=imageElement?imageElement.src:'/images/placeholder.png';if(window.productsManager){window.productsManager.showDeleteModal(productId,productName,productImage)}}document.addEventListener('DOMContentLoaded',()=>{window.productsManager=new ProductsManager()});const style=document.createElement('style');style.textContent=`@keyframes fadeOut{from{opacity:1}to{opacity:0}}`;document.head.appendChild(style);
