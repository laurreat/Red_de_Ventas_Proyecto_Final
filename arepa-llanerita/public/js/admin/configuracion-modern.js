/**
 * Configuracion Manager - Sistema Moderno PWA-Ready
 * Versión minificada para rendimiento <3s
 * Compatible con Bootstrap 5 Modals
 */
class ConfiguracionManager{constructor(){this.routes=window.configuracionRoutes||{};this.csrfToken=window.configuracionCSRF||document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||'';this.modals={};this.toasts=[];this.bootstrapReady=false;this.waitForBootstrap().then(()=>{this.init()})}
waitForBootstrap(){return new Promise((resolve)=>{const checkBootstrap=()=>{if(typeof bootstrap!=='undefined'&&bootstrap.Modal){this.bootstrapReady=true;resolve()}else{setTimeout(checkBootstrap,100)}};checkBootstrap()})}
init(){this.setupEventListeners();this.setupKeyboardShortcuts();this.animateOnLoad();console.log('ConfiguracionManager initialized with Bootstrap',bootstrap.Modal)}
setupEventListeners(){const self=this;document.querySelectorAll('[data-config-action]').forEach(btn=>{btn.addEventListener('click',e=>{e.preventDefault();const action=e.currentTarget.getAttribute('data-config-action');self.handleAction(action)})});document.querySelectorAll('.config-form-control').forEach(input=>{input.addEventListener('focus',e=>e.currentTarget.parentElement.classList.add('focused'));input.addEventListener('blur',e=>e.currentTarget.parentElement.classList.remove('focused'))});const collapseToggles=document.querySelectorAll('[data-bs-toggle="collapse"]');collapseToggles.forEach(toggle=>{toggle.addEventListener('click',e=>{const target=e.currentTarget.getAttribute('data-bs-target');const targetEl=document.querySelector(target);if(targetEl){targetEl.classList.toggle('show')}})})}
setupKeyboardShortcuts(){const self=this;document.addEventListener('keydown',e=>{if(e.key==='Escape'){const openModals=document.querySelectorAll('.modal.show');if(openModals.length>0){e.preventDefault()}}
if(e.ctrlKey&&e.key==='s'){const activeForm=document.activeElement.closest('form');if(activeForm){activeForm.requestSubmit();e.preventDefault()}}})}
animateOnLoad(){const cards=document.querySelectorAll('.config-stat-card');cards.forEach((card,idx)=>{card.classList.add('animate-fadeInUp');card.classList.add(`animate-delay-${Math.min(idx+1,4)}`);card.style.opacity='0'});const sections=document.querySelectorAll('.config-section-card');sections.forEach((section,idx)=>{section.classList.add('animate-fadeInUp');section.classList.add(`animate-delay-${Math.min(idx+1,4)}`);section.style.opacity='0'})}
handleAction(action){const actions={backup:()=>this.confirmBackup(),cache:()=>this.confirmCache(),logs:()=>this.confirmLogs(),info:()=>this.showInfoModal()};if(actions[action]){actions[action]()}else{console.warn(`Unknown action: ${action}`)}}
confirmBackup(){this.showConfirmDialog('¿Crear Backup del Sistema?','Se creará una copia de seguridad completa de la base de datos MongoDB. Este proceso puede tomar unos minutos.','info',()=>this.executeBackup())}
confirmCache(){this.showConfirmDialog('¿Limpiar Cache del Sistema?','Se limpiará todo el cache de la aplicación, rutas, configuración y vistas. La página se recargará automáticamente.','warning',()=>this.executeCache())}
confirmLogs(){this.showConfirmDialog('¿Limpiar Logs Antiguos?','Se eliminarán todos los archivos de log con más de 30 días de antigüedad. Esta acción no se puede deshacer.','danger',()=>this.executeLogs())}
showConfirmDialog(title,message,type,onConfirm){if(!this.bootstrapReady){console.error('Bootstrap not ready');return}
const iconMap={info:'info-circle-fill',warning:'exclamation-triangle-fill',danger:'exclamation-triangle-fill',success:'check-circle-fill'};const colorMap={info:'#17a2b8',warning:'#ffc107',danger:'#dc3545',success:'#28a745'};const modal=document.createElement('div');modal.className='modal fade';modal.id='confirmActionModal';modal.setAttribute('tabindex','-1');modal.setAttribute('role','dialog');modal.setAttribute('aria-labelledby','confirmActionModalLabel');modal.setAttribute('aria-hidden','true');modal.innerHTML=`<div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content border-0 shadow-lg"><div class="modal-header border-0" style="background:${colorMap[type]};color:${type==='warning'?'#000':'#fff'}"><h5 class="modal-title" id="confirmActionModalLabel"><i class="bi bi-${iconMap[type]} me-2"></i>${title}</h5><button type="button" class="btn-close${type!=='warning'?' btn-close-white':''}" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-4"><p class="mb-0">${message}</p></div><div class="modal-footer border-0"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Cancelar</button><button type="button" class="btn btn-${type==='danger'?'danger':type==='warning'?'warning':'primary'}" id="confirmActionBtn"><i class="bi bi-check-circle me-1"></i>Confirmar</button></div></div></div>`;document.body.appendChild(modal);try{const bsModal=new bootstrap.Modal(modal,{backdrop:true,keyboard:true,focus:true});bsModal.show();const confirmBtn=document.getElementById('confirmActionBtn');if(confirmBtn){confirmBtn.addEventListener('click',()=>{bsModal.hide();setTimeout(()=>onConfirm(),300)})}
modal.addEventListener('hidden.bs.modal',function(){setTimeout(()=>{if(document.body.contains(modal)){document.body.removeChild(modal)}},500)},{once:true})}catch(error){console.error('Error creating modal:',error);alert(message);if(confirm('¿Desea continuar?')){onConfirm()}}}
async showInfoModal(){if(!this.bootstrapReady){console.error('Bootstrap not ready');return}
const modal=document.createElement('div');modal.className='modal fade';modal.id='infoSistemaModal';modal.setAttribute('tabindex','-1');modal.setAttribute('role','dialog');modal.setAttribute('aria-labelledby','infoSistemaModalLabel');modal.setAttribute('aria-hidden','true');modal.innerHTML=`<div class="modal-dialog modal-lg modal-dialog-scrollable" role="document"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,#722F37 0%,#5a252c 100%);color:#fff"><h5 class="modal-title" id="infoSistemaModalLabel"><i class="bi bi-cpu me-2"></i>Información del Sistema</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="infoSistemaContent"><div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p class="mt-3 text-muted">Cargando información del sistema...</p></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div></div></div>`;document.body.appendChild(modal);try{const bsModal=new bootstrap.Modal(modal,{backdrop:true,keyboard:true,focus:true});bsModal.show();modal.addEventListener('hidden.bs.modal',function(){setTimeout(()=>{if(document.body.contains(modal)){document.body.removeChild(modal)}},500)},{once:true});const response=await fetch(this.routes.infoSistema,{headers:{'X-CSRF-TOKEN':this.csrfToken,'Content-Type':'application/json'}});const data=await response.json();const content=document.getElementById('infoSistemaContent');if(data.success){let html='';html+=this.renderInfoSection('Información del Sistema','cpu',data.data.sistema||{});html+=this.renderInfoSection('Información de la Aplicación','app-indicator',data.data.aplicacion||{});html+=this.renderInfoSection('Estadísticas de Uso','graph-up-arrow',data.data.estadisticas||{});content.innerHTML=html}else{content.innerHTML=`<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>${data.message}</div>`}}catch(error){const content=document.getElementById('infoSistemaContent');if(content){content.innerHTML=`<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle me-2"></i>Error: ${error.message}</div>`}}}
renderInfoSection(title,icon,data){let html=`<div class="mb-4 px-3"><h6 class="fw-bold mb-3" style="color:#722F37"><i class="bi bi-${icon} me-2"></i>${title}</h6><div class="config-info-grid">`;Object.keys(data).forEach(key=>{html+=`<div class="config-info-item"><strong>${key}</strong><span>${data[key]}</span></div>`});html+='</div></div>';return html}
async executeBackup(){this.showLoading('Creando backup del sistema...');try{const response=await fetch(this.routes.backup,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrfToken}});if(!response.ok){const data=await response.json();this.hideLoading();this.showToast('danger','Error al Crear Backup',data.message||'Error desconocido');return}const blob=await response.blob();const contentDisposition=response.headers.get('Content-Disposition');let filename='backup_arepa_llanerita.json';if(contentDisposition){const filenameMatch=contentDisposition.match(/filename="?(.+)"?/i);if(filenameMatch&&filenameMatch[1]){filename=filenameMatch[1]}}const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.style.display='none';a.href=url;a.download=filename;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);document.body.removeChild(a);this.hideLoading();this.showToast('success','Backup Descargado Exitosamente',`El archivo <strong>${filename}</strong> se ha descargado a tu PC`)}catch(error){this.hideLoading();this.showToast('danger','Error de Conexión',error.message)}}
async executeCache(){this.showLoading('Limpiando cache del sistema...');try{const response=await fetch(this.routes.limpiarCache,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrfToken,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success','Cache Limpiado','El cache se ha limpiado exitosamente. Recargando página...');setTimeout(()=>location.reload(),2000)}else{this.showToast('danger','Error al Limpiar Cache',data.message)}}catch(error){this.hideLoading();this.showToast('danger','Error de Conexión',error.message)}}
async executeLogs(){this.showLoading('Limpiando logs antiguos...');try{const response=await fetch(this.routes.limpiarLogs,{method:'POST',headers:{'X-CSRF-TOKEN':this.csrfToken,'Content-Type':'application/json'}});const data=await response.json();this.hideLoading();if(data.success){this.showToast('success','Logs Limpiados',data.message)}else{this.showToast('danger','Error al Limpiar Logs',data.message)}}catch(error){this.hideLoading();this.showToast('danger','Error de Conexión',error.message)}}
showToast(type,title,message,duration=5000){const toast=document.createElement('div');toast.className=`config-toast ${type}`;const icons={success:'check-circle-fill',danger:'exclamation-triangle-fill',warning:'exclamation-triangle-fill',info:'info-circle-fill'};toast.innerHTML=`<i class="bi bi-${icons[type]||'info-circle-fill'} config-toast-icon text-${type}"></i><div class="config-toast-content"><h6>${title}</h6><p>${message}</p></div><button class="config-toast-close">&times;</button>`;document.body.appendChild(toast);toast.querySelector('.config-toast-close').onclick=()=>this.removeToast(toast);setTimeout(()=>this.removeToast(toast),duration);this.toasts.push(toast)}
removeToast(toast){toast.style.animation='slideInRight 0.3s ease-out reverse';setTimeout(()=>{if(toast.parentElement)toast.parentElement.removeChild(toast);this.toasts=this.toasts.filter(t=>t!==toast)},300)}
showLoading(message='Cargando...'){let overlay=document.getElementById('config-loading-overlay');if(!overlay){overlay=document.createElement('div');overlay.id='config-loading-overlay';overlay.className='config-loading-overlay';overlay.innerHTML=`<div class="text-center"><div class="config-loading-spinner"></div><p class="mt-3 fw-bold" style="color:#722F37">${message}</p></div>`;document.body.appendChild(overlay)}else{const p=overlay.querySelector('p');if(p)p.textContent=message}
overlay.classList.add('show')}
hideLoading(){const overlay=document.getElementById('config-loading-overlay');if(overlay){overlay.classList.remove('show');setTimeout(()=>{if(overlay.parentElement)overlay.parentElement.removeChild(overlay)},300)}}}
document.addEventListener('DOMContentLoaded',()=>{window.configuracionManager=new ConfiguracionManager()});
window.crearBackup=()=>window.configuracionManager?.handleAction('backup');window.limpiarCache=()=>window.configuracionManager?.handleAction('cache');window.limpiarLogs=()=>window.configuracionManager?.handleAction('logs');window.mostrarInfoSistema=()=>window.configuracionManager?.handleAction('info');
