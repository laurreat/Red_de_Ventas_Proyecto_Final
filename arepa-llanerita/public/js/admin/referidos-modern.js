/* Referidos Modern JS - Manager Optimizado para PWA */
class ReferidosManager{constructor(){this.routes=window.routes||{};this.redData=window.redData||[];this.usuarioSeleccionado=window.usuarioSeleccionado||null;this.modals={};this.toasts=[];this.debounceTimers={};this.init()}init(){this.setupEventListeners();this.animateCards();this.initializeTooltips();this.checkPWAStatus();console.log('âœ… ReferidosManager initialized')}setupEventListeners(){const t=this;document.querySelectorAll('[data-action="search"]')?.forEach(e=>{e.addEventListener('submit',e=>t.handleSearch(e))});document.querySelectorAll('[data-action="clear-search"]')?.forEach(e=>{e.addEventListener('click',()=>t.clearSearch())});document.querySelectorAll('[data-action="random-user"]')?.forEach(e=>{e.addEventListener('click',()=>t.showRandomUser())});document.querySelectorAll('[data-action="export"]')?.forEach(e=>{e.addEventListener('click',e=>t.handleExport(e.currentTarget.dataset.format))});document.addEventListener('keydown',e=>{'Escape'===e.key&&this.closeAllModals()});const a=document.getElementById('cedula_search');a&&a.addEventListener('input',t.debounce(e=>t.validateCedula(e.target),300))}handleSearch(t){t.preventDefault();const e=new FormData(t.target),a=e.get('cedula');if(!a||a.trim().length<6)return this.showToast('Por favor ingrese una cÃ©dula vÃ¡lida (mÃ­nimo 6 dÃ­gitos)','warning'),!1;if(!/^[0-9]{6,12}$/.test(a))return this.showToast('La cÃ©dula debe contener solo nÃºmeros (6-12 dÃ­gitos)','danger'),!1;this.showLoading('Buscando usuario...');const s=new URL(window.location.href);s.searchParams.set('cedula',a),window.location.href=s.toString()}clearSearch(){const t=new URL(window.location.href);t.searchParams.delete('cedula'),window.location.href=t.toString()}showRandomUser(){this.showLoading('Seleccionando usuario aleatorio...');const t=document.querySelectorAll('[data-cedula]');if(t.length>0){const e=t[Math.floor(Math.random()*t.length)],a=e.dataset.cedula;if(a){const t=new URL(window.location.href);t.searchParams.set('cedula',a),setTimeout(()=>window.location.href=t.toString(),500)}else this.hideLoading(),this.showToast('No se pudo obtener la cÃ©dula del usuario','danger')}else this.hideLoading(),this.showToast('No hay usuarios disponibles para selecciÃ³n aleatoria','warning')}validateCedula(t){const e=t.value.trim();if(e.length>0){if(!/^[0-9]*$/.test(e))return t.classList.add('is-invalid'),t.classList.remove('is-valid'),void this.showToast('La cÃ©dula debe contener solo nÃºmeros','warning');e.length>=6&&e.length<=12?(t.classList.add('is-valid'),t.classList.remove('is-invalid')):(t.classList.add('is-invalid'),t.classList.remove('is-valid'))}else t.classList.remove('is-valid','is-invalid')}handleExport(t){const e=this.usuarioSeleccionado?.cedula||'',a=`${this.routes.export||'/admin/referidos/exportar'}?formato=${t}${e?`&cedula=${e}`:''}`;this.showLoading(`Generando exportaciÃ³n ${t.toUpperCase()}...`),fetch(a,{method:'GET',headers:{Accept:'pdf'===t?'application/pdf':'text/csv','X-Requested-With':'XMLHttpRequest'}}).then(e=>{if(!e.ok)throw new Error(`Error ${e.status}: ${e.statusText}`);return e.blob()}).then(e=>{const a=window.URL.createObjectURL(e),s=document.createElement('a');s.href=a,s.download=`red_referidos_${new Date().toISOString().split('T')[0]}.${t}`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a),this.hideLoading(),this.showToast(`ExportaciÃ³n ${t.toUpperCase()} descargada exitosamente`,'success')}).catch(e=>{console.error('Export error:',e),this.hideLoading(),this.showToast(`Error al exportar: ${e.message}`,'danger')})}animateCards(){const t=document.querySelectorAll('.referidos-stat-card, .referidos-top-item, .referidos-table-container tbody tr');t.forEach((t,e)=>{t.style.opacity='0',setTimeout(()=>{t.classList.add('animate-fade-in-up'),t.style.opacity='1'},50*e)})}initializeTooltips(){'function'==typeof bootstrap?.Tooltip&&document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(t=>new bootstrap.Tooltip(t))}checkPWAStatus(){window.matchMedia('(display-mode: standalone)').matches?console.log('ðŸš€ Running as PWA'):'serviceWorker'in navigator&&navigator.serviceWorker.controller?console.log('ðŸ”„ PWA ready but not installed'):console.log('ðŸ“± Running as web app')}createModal(t){const e=document.createElement('div');e.className='referidos-modal',e.innerHTML=`\n            <div class="referidos-modal-backdrop"></div>\n            <div class="referidos-modal-content">\n                <div class="referidos-modal-header ${t.type?`referidos-modal-${t.type}`:''}">\n                    <h5 class="referidos-modal-title">${t.title||'Modal'}</h5>\n                    <button class="referidos-modal-close" data-dismiss="modal">&times;</button>\n                </div>\n                <div class="referidos-modal-body">${t.body||''}</div>\n                ${t.footer?`<div class="referidos-modal-footer">${t.footer}</div>`:''}\n            </div>\n        `;const a=Date.now();return this.modals[a]=e,e.querySelector('.referidos-modal-close').addEventListener('click',()=>this.closeModal(a)),e.querySelector('.referidos-modal-backdrop').addEventListener('click',()=>this.closeModal(a)),e}showModal(t){document.body.appendChild(t),setTimeout(()=>{t.style.display='flex'},10)}closeModal(t){const e=this.modals[t];e&&(e.style.opacity='0',setTimeout(()=>{e.remove(),delete this.modals[t]},300))}closeAllModals(){Object.keys(this.modals).forEach(t=>this.closeModal(t))}showToast(t,e='info',a=5e3){const s=document.createElement('div');s.className=`referidos-toast referidos-toast-${e}`;const i={success:'âœ“',warning:'âš ',danger:'âœ•',info:'â„¹'}[e]||'â„¹';s.innerHTML=`\n            <div class="referidos-toast-icon">${i}</div>\n            <div class="referidos-toast-content">\n                <div class="referidos-toast-title">${this.getToastTitle(e)}</div>\n                <div class="referidos-toast-message">${t}</div>\n            </div>\n            <button class="referidos-toast-close">&times;</button>\n        `,document.body.appendChild(s);const o=Date.now();this.toasts.push({id:o,element:s}),s.querySelector('.referidos-toast-close').addEventListener('click',()=>this.closeToast(o)),a>0&&setTimeout(()=>this.closeToast(o),a)}getToastTitle(t){return{success:'Ã‰xito',warning:'Advertencia',danger:'Error',info:'InformaciÃ³n'}[t]||'NotificaciÃ³n'}closeToast(t){const e=this.toasts.find(e=>e.id===t);if(e){e.element.style.opacity='0',e.element.style.transform='translateX(100%)';setTimeout(()=>{e.element.remove(),this.toasts=this.toasts.filter(e=>e.id!==t)},300)}}showLoading(t='Cargando...',e='Procesando datos'){const a=document.getElementById('referidos-loading')||this.createLoadingElement();a.querySelector('.referidos-loading-text').textContent=t,a.querySelector('.referidos-loading-subtext').textContent=e,a.style.display='flex'}hideLoading(){const t=document.getElementById('referidos-loading');t&&(t.style.opacity='0',setTimeout(()=>{t.style.display='none',t.style.opacity='1'},300))}createLoadingElement(){const t=document.createElement('div');return t.id='referidos-loading',t.className='referidos-loading',t.innerHTML='\n            <div class="referidos-loading-spinner"></div>\n            <div class="referidos-loading-text">Cargando...</div>\n            <div class="referidos-loading-subtext">Procesando datos</div>\n        ',document.body.appendChild(t),t}debounce(t,e){return function(...a){const s=this;clearTimeout(this.debounceTimers[t]),this.debounceTimers[t]=setTimeout(()=>t.apply(s,a),e)}}formatNumber(t){return new Intl.NumberFormat('es-CO').format(t)}formatCurrency(t,e='VES'){return new Intl.NumberFormat('es-CO',{style:'currency',currency:e}).format(t)}formatDate(t){return new Intl.DateTimeFormat('es-CO',{year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date(t))}sanitizeHTML(t){const e=document.createElement('div');return e.textContent=t,e.innerHTML}validateMongoDBId(t){return/^[a-f\d]{24}$/i.test(t)}}document.addEventListener('DOMContentLoaded',()=>{window.referidosManager=new ReferidosManager,console.log('âœ… Referidos Modern JS loaded successfully')});function exportarRed(){window.referidosManager?.handleExport('json')||console.error('ReferidosManager not initialized')}function exportarRedPDF(){window.referidosManager?.handleExport('pdf')||console.error('ReferidosManager not initialized')}function exportarRedCSV(){window.referidosManager?.handleExport('csv')||console.error('ReferidosManager not initialized')}function searchUserNetwork(t){window.referidosManager?.handleSearch(t)||console.error('ReferidosManager not initialized')}function clearSearch(){window.referidosManager?.clearSearch()||console.error('ReferidosManager not initialized')}function showRandomUser(){window.referidosManager?.showRandomUser()||console.error('ReferidosManager not initialized')}function verVisualizacion(){const t=document.getElementById('network-container')||document.getElementById('referidos-network-container');t?t.scrollIntoView({behavior:'smooth',block:'center'}):window.referidosManager?.showToast('SecciÃ³n de visualizaciÃ³n no encontrada','warning')}
