class ComisionesManager{constructor(){this.routes=window.comisionesRoutes||{};this.csrfToken=window.comisionesCSRF||'';this.loadingOverlay=null;this.init()}init(){this.createLoadingOverlay();this.initEventListeners();this.animateTableRows();console.log('\u2705 ComisionesManager inicializado')}createLoadingOverlay(){if(!this.loadingOverlay){this.loadingOverlay=document.createElement('div');this.loadingOverlay.className='comisiones-loading-overlay';this.loadingOverlay.innerHTML='<div><div class="comisiones-loading-spinner"></div><div class="comisiones-loading-text">Procesando...</div></div>';document.body.appendChild(this.loadingOverlay)}}initEventListeners(){const calcBtn=document.querySelector('[data-action="calcular-comisiones"]');if(calcBtn){calcBtn.addEventListener('click',()=>this.calcularComisiones())}const exportBtn=document.querySelector('[data-action="exportar-comisiones"]');if(exportBtn){exportBtn.addEventListener('click',()=>this.exportarComisiones())}document.addEventListener('keydown',e=>{if(e.key==='Escape'){this.closeAllModals()}})}animateTableRows(){const rows=document.querySelectorAll('.comisiones-table-container tbody tr');rows.forEach((row,index)=>{row.style.opacity='0';row.style.animation=`fadeInUp 0.5s ease-out ${index*.05}s forwards`})}calcularComisiones(){const fechaInicio=document.querySelector('input[name="fecha_inicio"]');const fechaFin=document.querySelector('input[name="fecha_fin"]');if(!fechaInicio||!fechaFin||!fechaInicio.value||!fechaFin.value){this.showToast('Por favor selecciona un per\u00edodo v\u00e1lido','warning');return}const calcRoute=this.routes.calcular||'#';if(calcRoute==='#'){this.showToast('Ruta de c\u00e1lculo no configurada','error');return}this.showLoading('Calculando comisiones...');fetch(calcRoute,{method:'POST',headers:{'Content-Type':'application/json','X-CSRF-TOKEN':this.csrfToken,'Accept':'application/json'},body:JSON.stringify({fecha_inicio:fechaInicio.value,fecha_fin:fechaFin.value})}).then(res=>{if(!res.ok)throw new Error(`HTTP ${res.status}`);return res.json()}).then(data=>{this.hideLoading();if(data.success){const total=this.formatMoney(data.total_comisiones||0);this.showModal({title:'\u2705 C\u00e1lculo Exitoso',body:`<div class="text-center py-3">
<i class="bi bi-check-circle text-success" style="font-size:4rem"></i>
<h4 class="mt-3">Comisiones Calculadas</h4>
<p class="text-muted">Per\u00edodo: ${fechaInicio.value} a ${fechaFin.value}</p>
<h3 class="text-success fw-bold">${total}</h3>
<p class="text-muted">Total en comisiones</p>
<div class="mt-3"><strong>${Object.keys(data.resumen||{}).length}</strong> vendedores procesados</div>
</div>`,type:'success',buttons:[{text:'Ver Detalles',class:'btn-wine',action:()=>{this.closeAllModals();setTimeout(()=>window.location.reload(),300)}},{text:'Cerrar',class:'btn btn-secondary',action:()=>this.closeAllModals()}]})}else{this.showToast(data.mensaje||'Error al calcular comisiones','error')}}).catch(err=>{this.hideLoading();console.error('Error:',err);this.showToast('Error al calcular comisiones','error')})}exportarComisiones(){const fechaInicio=document.querySelector('input[name="fecha_inicio"]');const fechaFin=document.querySelector('input[name="fecha_fin"]');if(!fechaInicio||!fechaFin||!fechaInicio.value||!fechaFin.value){this.showToast('Por favor selecciona un per\u00edodo v\u00e1lido','warning');return}const exportRoute=this.routes.exportar||'#';if(exportRoute==='#'){this.showToast('Ruta de exportaci\u00f3n no configurada','error');return}const form=document.createElement('form');form.method='POST';form.action=exportRoute;form.target='_blank';const csrf=document.createElement('input');csrf.type='hidden';csrf.name='_token';csrf.value=this.csrfToken;form.appendChild(csrf);const fi=document.createElement('input');fi.type='hidden';fi.name='fecha_inicio';fi.value=fechaInicio.value;form.appendChild(fi);const ff=document.createElement('input');ff.type='hidden';ff.name='fecha_fin';ff.value=fechaFin.value;form.appendChild(ff);const fmt=document.createElement('input');fmt.type='hidden';fmt.name='formato';fmt.value='pdf';form.appendChild(fmt);document.body.appendChild(form);form.submit();document.body.removeChild(form);this.showToast('\ud83d\udcc4 Generando PDF de comisiones...','info')}showModal(options){const{title='',body='',type='primary',buttons=[]}=options;const modal=document.createElement('div');modal.className='comisiones-modal active animate-fade-in';const typeColors={primary:'var(--primary)',success:'var(--success)',warning:'var(--warning)',danger:'var(--danger)',info:'var(--info)'};const headerColor=typeColors[type]||typeColors.primary;modal.innerHTML=`
<div class="comisiones-modal-backdrop" data-dismiss="modal"></div>
<div class="comisiones-modal-content animate-scale-in">
<div class="comisiones-modal-header" style="border-color:${headerColor}">
<h3 style="color:${headerColor}">${title}</h3>
<button class="close" data-dismiss="modal">&times;</button>
</div>
<div class="comisiones-modal-body">${body}</div>
<div class="comisiones-modal-footer">
${buttons.map((btn,i)=>`<button class="${btn.class||'btn btn-secondary'}" data-btn-index="${i}">${btn.text||'Cerrar'}</button>`).join('')}
</div>
</div>`;document.body.appendChild(modal);setTimeout(()=>{modal.querySelectorAll('[data-dismiss="modal"]').forEach(el=>{el.addEventListener('click',()=>{this.closeModal(modal)})});buttons.forEach((btn,i)=>{const btnEl=modal.querySelector(`[data-btn-index="${i}"]`);if(btnEl&&btn.action){btnEl.addEventListener('click',()=>{btn.action();if(btn.closeAfter!==false)this.closeModal(modal)})}})},100);return modal}closeModal(modal){if(!modal)return;modal.classList.remove('active');setTimeout(()=>{if(modal.parentNode)modal.parentNode.removeChild(modal)},300)}closeAllModals(){document.querySelectorAll('.comisiones-modal.active').forEach(modal=>{this.closeModal(modal)})}showToast(message,type='info'){const toast=document.createElement('div');toast.className=`comisiones-toast ${type} animate-slide-in-right`;const icons={success:'\u2705',error:'\u274c',warning:'\u26a0\ufe0f',info:'\u2139\ufe0f'};const icon=icons[type]||icons.info;toast.innerHTML=`
<span class="icon">${icon}</span>
<span class="message">${message}</span>
<button class="close">&times;</button>`;document.body.appendChild(toast);const closeBtn=toast.querySelector('.close');closeBtn.addEventListener('click',()=>{toast.style.animation='slideInRight 0.3s ease-out reverse';setTimeout(()=>{if(toast.parentNode)toast.parentNode.removeChild(toast)},300)});setTimeout(()=>{if(toast.parentNode){toast.style.animation='slideInRight 0.3s ease-out reverse';setTimeout(()=>{if(toast.parentNode)toast.parentNode.removeChild(toast)},300)}},4000)}showLoading(text='Procesando...'){if(this.loadingOverlay){const textEl=this.loadingOverlay.querySelector('.comisiones-loading-text');if(textEl)textEl.textContent=text;this.loadingOverlay.classList.add('active')}}hideLoading(){if(this.loadingOverlay){this.loadingOverlay.classList.remove('active')}}formatMoney(amount,currency='VES'){const num=typeof amount==='number'?amount:parseFloat(amount)||0;return`${currency} ${num.toLocaleString('es-VE',{minimumFractionDigits:2,maximumFractionDigits:2})}`}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}}}let comisionesManagerInstance=null;document.addEventListener('DOMContentLoaded',()=>{comisionesManagerInstance=new ComisionesManager()});window.ComisionesManager=ComisionesManager;window.getComisionesManager=()=>comisionesManagerInstance;
