class ReportesManager{constructor(){if(ReportesManager.instance){return ReportesManager.instance}ReportesManager.instance=this;this.routes=window.reportesRoutes||{};this.ventasPorDiaData=window.ventasPorDiaData||{labels:[],data:[]};this.ventasPorEstadoData=window.ventasPorEstadoData||{labels:[],data:[]};this.charts={};this.colors={primary:'#722F37',success:'#28a745',warning:'#ffc107',danger:'#dc3545',info:'#17a2b8',secondary:'#6c757d'};this.init()}init(){this.initCharts();this.animateStatsCards();document.addEventListener('DOMContentLoaded',()=>{this.hideLoading()})}initCharts(){this.initVentasPorDiaChart();this.initVentasPorEstadoChart()}initVentasPorDiaChart(){const ctx=document.getElementById('ventasPorDiaChart');if(!ctx)return;if(this.charts.ventasPorDia){this.charts.ventasPorDia.destroy()}this.charts.ventasPorDia=new Chart(ctx,{type:'line',data:{labels:this.ventasPorDiaData.labels,datasets:[{label:'Ventas Diarias',data:this.ventasPorDiaData.data,borderColor:this.colors.primary,backgroundColor:`${this.colors.primary}20`,borderWidth:2,fill:true,tension:0.4,pointBackgroundColor:this.colors.primary,pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:5,pointHoverRadius:7}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'top',labels:{font:{size:12,family:"'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"},color:'#333',padding:15}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:this.colors.primary,borderWidth:1,padding:12,displayColors:true,callbacks:{label:function(context){return`Ventas: ${new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(context.parsed.y)}`}}}},scales:{y:{beginAtZero:true,ticks:{callback:function(value){return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(value)},color:'#666',font:{size:11}},grid:{color:'rgba(0,0,0,0.05)',drawBorder:false}},x:{ticks:{color:'#666',font:{size:11}},grid:{display:false,drawBorder:false}}}}})}initVentasPorEstadoChart(){const ctx=document.getElementById('ventasPorEstadoChart');if(!ctx)return;if(this.charts.ventasPorEstado){this.charts.ventasPorEstado.destroy()}const estadoColors={entregado:this.colors.success,en_camino:this.colors.info,preparando:this.colors.warning,confirmado:'#007bff',pendiente:this.colors.secondary,cancelado:this.colors.danger};const backgroundColors=this.ventasPorEstadoData.labels.map(label=>estadoColors[label.toLowerCase().replace(/\s+/g,'_')]||this.colors.secondary);this.charts.ventasPorEstado=new Chart(ctx,{type:'doughnut',data:{labels:this.ventasPorEstadoData.labels,datasets:[{data:this.ventasPorEstadoData.data,backgroundColor:backgroundColors,borderColor:'#fff',borderWidth:3,hoverOffset:15}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'right',labels:{font:{size:12,family:"'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"},color:'#333',padding:12,boxWidth:15}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:this.colors.primary,borderWidth:1,padding:12,callbacks:{label:function(context){const label=context.label||'';const value=context.parsed||0;const total=context.dataset.data.reduce((a,b)=>a+b,0);const percentage=((value/total)*100).toFixed(1);return`${label}: ${value} (${percentage}%)`}}}},cutout:'60%'}})}animateStatsCards(){const cards=document.querySelectorAll('.stat-card');cards.forEach((card,index)=>{setTimeout(()=>{card.style.animation=`slideInUp 0.5s ease-out forwards`;card.style.opacity='1'},index*100)})}async exportarPDF(){this.showLoading('Generando PDF...');try{const fechaInicio=document.getElementById('fechaInicio')?.value||'';const fechaFin=document.getElementById('fechaFin')?.value||'';const vendedorId=document.getElementById('vendedorId')?.value||'';const params=new URLSearchParams();if(fechaInicio)params.append('fecha_inicio',fechaInicio);if(fechaFin)params.append('fecha_fin',fechaFin);if(vendedorId)params.append('vendedor_id',vendedorId);const url=`${this.routes.exportar}?${params.toString()}`;const response=await fetch(url,{method:'GET',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||''}});if(!response.ok){const errorData=await response.json().catch(()=>({}));throw new Error(errorData.error||`Error ${response.status}: ${response.statusText}`)}const blob=await response.blob();const downloadUrl=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=downloadUrl;a.download=`reporte-ventas-${new Date().toISOString().split('T')[0]}.pdf`;document.body.appendChild(a);a.click();window.URL.revokeObjectURL(downloadUrl);document.body.removeChild(a);this.showToast('PDF generado exitosamente','success')}catch(error){console.error('Error exportando PDF:',error);this.showToast('Error al generar el PDF: '+error.message,'error')}finally{this.hideLoading()}}showToast(message,type='info'){const toastContainer=document.getElementById('toast-container')||this.createToastContainer();const toast=document.createElement('div');toast.className=`toast-notification toast-${type}`;const icons={success:'',error:'',warning:'ï¿½',info:'9'};toast.innerHTML=`<span class="toast-icon">${icons[type]||icons.info}</span><span class="toast-message">${message}</span>`;toastContainer.appendChild(toast);setTimeout(()=>{toast.style.animation='slideOut 0.3s ease-out forwards'},3700);setTimeout(()=>{toast.remove()},4000)}createToastContainer(){const container=document.createElement('div');container.id='toast-container';container.style.cssText='position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;';document.body.appendChild(container);return container}showLoading(message='Cargando...'){let loader=document.getElementById('custom-loader');if(!loader){loader=document.createElement('div');loader.id='custom-loader';loader.innerHTML=`<div class="loader-overlay"><div class="loader-spinner"></div><div class="loader-text">${message}</div></div>`;document.body.appendChild(loader)}else{loader.querySelector('.loader-text').textContent=message}loader.style.display='flex'}hideLoading(){const loader=document.getElementById('custom-loader');if(loader){loader.style.display='none'}}}const reportesManager=new ReportesManager();window.reportesManager=reportesManager;window.exportarReporte=function(){reportesManager.exportarPDF()};const style=document.createElement('style');style.textContent=`@keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes slideOut{to{opacity:0;transform:translateX(100%)}}@keyframes spin{to{transform:rotate(360deg)}}.loader-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000}.loader-spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.3);border-top-color:#722F37;border-radius:50%;animation:spin 0.8s linear infinite}.loader-text{color:#fff;margin-top:15px;font-size:16px;font-weight:500}.toast-notification{padding:15px 20px;border-radius:8px;color:#fff;display:flex;align-items:center;gap:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:250px;animation:slideInUp 0.3s ease-out}.toast-success{background:#28a745}.toast-error{background:#dc3545}.toast-warning{background:#ffc107;color:#000}.toast-info{background:#17a2b8}.toast-icon{font-size:18px;font-weight:bold}.toast-message{flex:1;font-size:14px}#custom-loader{display:none}`;document.head.appendChild(style);
