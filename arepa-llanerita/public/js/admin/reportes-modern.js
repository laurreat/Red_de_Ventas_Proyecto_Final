/**
 * Módulo Reportes - JavaScript Profesional Minificado v4.0
 * PWA-ready | Optimizado para rendimiento < 3s | Chart.js lazy loading
 * Tamaño: ~8KB minificado
 */
class ReporteManager{constructor(){this.routes=window.reportesRoutes||{};this.charts={};this.chartInstances={};this.debounceTimers={};this.isChartJsLoaded=!1;this.init()}init(){this.setupEventListeners();this.initCharts();this.initAnimations();console.log('✓ ReporteManager inicializado correctamente')}setupEventListeners(){const t=this;document.addEventListener('click',function(e){if(e.target.classList.contains('reporte-btn-danger')||e.target.closest('.reporte-btn-danger')){e.preventDefault();t.exportarPDF()}});const e=document.querySelectorAll('input[name="fecha_inicio"], input[name="fecha_fin"], select[name="vendedor_id"]');e.forEach(i=>{i.addEventListener('change',()=>{t.debounce('filterChange',()=>{const r=i.closest('form');r&&r.submit()},500)})})}debounce(t,e,i=300){clearTimeout(this.debounceTimers[t]);this.debounceTimers[t]=setTimeout(e,i)}async loadChartJs(){if(this.isChartJsLoaded)return Promise.resolve();if(window.Chart)return this.isChartJsLoaded=!0,Promise.resolve();return new Promise((t,e)=>{const i=document.createElement('script');i.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';i.onload=()=>{this.isChartJsLoaded=!0;t()};i.onerror=()=>e(new Error('Error cargando Chart.js'));document.head.appendChild(i)})}async initCharts(){try{await this.loadChartJs();this.createVentasPorDiaChart();this.createVentasPorEstadoChart();this.createTopProductosChart();this.createTopClientesChart()}catch(t){console.error('Error inicializando gráficos:',t)}}createVentasPorDiaChart(){const t=document.getElementById('ventasPorDiaChart');if(!t||!window.ventasPorDiaData)return;const e={responsive:!0,maintainAspectRatio:!1,interaction:{mode:'index',intersect:!1},plugins:{legend:{display:!0,position:'top',labels:{font:{size:12,weight:'600'},color:'#374151',padding:15,usePointStyle:!0}},tooltip:{backgroundColor:'#722F37',titleColor:'#fff',bodyColor:'#fff',padding:12,titleFont:{size:14,weight:'bold'},bodyFont:{size:13},borderColor:'rgba(114,47,55,0.3)',borderWidth:1,cornerRadius:8,displayColors:!1,callbacks:{label:function(i){return'Ingresos: $'+i.parsed.y.toLocaleString('es-CO')}}},title:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:function(i){return'$'+i.toLocaleString('es-CO')},color:'#6b7280',font:{size:11}},grid:{color:'#e5e7eb',borderDash:[5,5]}},x:{ticks:{color:'#6b7280',font:{size:11},maxRotation:45,minRotation:0},grid:{display:!1}}}};if(this.chartInstances.ventasPorDia){this.chartInstances.ventasPorDia.destroy()}this.chartInstances.ventasPorDia=new Chart(t,{type:'line',data:window.ventasPorDiaData,options:e})}createVentasPorEstadoChart(){const t=document.getElementById('ventasPorEstadoChart');if(!t||!window.ventasPorEstadoData)return;const e={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'bottom',labels:{font:{size:11,weight:'600'},color:'#374151',padding:10,usePointStyle:!0,boxWidth:12}},tooltip:{backgroundColor:'#722F37',titleColor:'#fff',bodyColor:'#fff',padding:12,borderColor:'rgba(114,47,55,0.3)',borderWidth:1,cornerRadius:8,callbacks:{label:function(i){const r=i.label||'';const a='$'+i.parsed.toLocaleString('es-CO');const n=i.dataset.data.reduce((o,s)=>o+s,0);const c=((i.parsed/n)*100).toFixed(1);return[r,a,c+'% del total']}}},title:{display:!1}},cutout:'60%'};if(this.chartInstances.ventasPorEstado){this.chartInstances.ventasPorEstado.destroy()}this.chartInstances.ventasPorEstado=new Chart(t,{type:'doughnut',data:window.ventasPorEstadoData,options:e})}createTopProductosChart(){const t=document.getElementById('topProductosChart');if(!t||!window.topProductosData)return;const e={responsive:!0,maintainAspectRatio:!1,indexAxis:'y',plugins:{legend:{display:!1},tooltip:{backgroundColor:'#722F37',padding:12,callbacks:{label:function(i){return'Ventas: $'+i.parsed.x.toLocaleString('es-CO')}}}},scales:{x:{beginAtZero:!0,ticks:{callback:function(i){return'$'+i.toLocaleString('es-CO')},color:'#6b7280',font:{size:10}},grid:{color:'#e5e7eb'}},y:{ticks:{color:'#374151',font:{size:11,weight:'600'}},grid:{display:!1}}}};if(this.chartInstances.topProductos){this.chartInstances.topProductos.destroy()}this.chartInstances.topProductos=new Chart(t,{type:'bar',data:window.topProductosData,options:e})}createTopClientesChart(){const t=document.getElementById('topClientesChart');if(!t||!window.topClientesData)return;const e={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:'#722F37',padding:12,callbacks:{label:function(i){return'Total: $'+i.parsed.y.toLocaleString('es-CO')}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(i){return'$'+i.toLocaleString('es-CO')},color:'#6b7280',font:{size:10}},grid:{color:'#e5e7eb'}},x:{ticks:{color:'#374151',font:{size:10},maxRotation:45,minRotation:45},grid:{display:!1}}}};if(this.chartInstances.topClientes){this.chartInstances.topClientes.destroy()}this.chartInstances.topClientes=new Chart(t,{type:'bar',data:window.topClientesData,options:e})}initAnimations(){const t=document.querySelectorAll('.reporte-stat-card');t.forEach((e,i)=>{setTimeout(()=>{e.classList.add('fade-in-up')},i*100)});const a=document.querySelectorAll('.reporte-ranking-item');a.forEach((e,i)=>{setTimeout(()=>{e.classList.add('fade-in-up')},i*50)})}async exportarPDF(){const t=this;const e=document.querySelector('.reporte-btn-danger');if(!e)return;const i=e.innerHTML;e.innerHTML='<i class="bi bi-arrow-repeat spin"></i> Generando PDF...';e.disabled=!0;try{const r=document.querySelector('input[name="fecha_inicio"]');const a=document.querySelector('input[name="fecha_fin"]');const n=document.querySelector('select[name="vendedor_id"]');const o=new URLSearchParams;if(r&&r.value)o.append('fecha_inicio',r.value);if(a&&a.value)o.append('fecha_fin',a.value);if(n&&n.value)o.append('vendedor_id',n.value);const s=this.routes.exportar||window.location.href.replace(/\/ventas.*$/,'/exportar-ventas');const c=s+(s.includes('?')?'&':'?')+o.toString();const l=await fetch(c,{method:'GET',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRF-TOKEN':document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||''}});if(!l.ok){throw new Error('Error en la respuesta del servidor')}const u=await l.blob();const h=window.URL.createObjectURL(u);const d=document.createElement('a');d.href=h;const p=new Date;const m=p.toISOString().split('T')[0];d.download=`reporte_ventas_${m}.pdf`;document.body.appendChild(d);d.click();document.body.removeChild(d);window.URL.revokeObjectURL(h);this.showToast('success','¡Reporte descargado!','El PDF se ha descargado correctamente.')}catch(r){console.error('Error al exportar PDF:',r);this.showToast('error','Error al exportar','No se pudo generar el PDF. Inténtalo nuevamente.')}finally{e.innerHTML=i;e.disabled=!1}}showToast(t,e,i){const r=document.createElement('div');r.className=`reporte-toast ${t}`;const a=this.getToastIcon(t);r.innerHTML=`
            <div class="reporte-toast-icon">${a}</div>
            <div class="reporte-toast-content">
                <div class="reporte-toast-title">${e}</div>
                <div class="reporte-toast-message">${i}</div>
            </div>
        `;document.body.appendChild(r);setTimeout(()=>{r.style.opacity='0';setTimeout(()=>{document.body.removeChild(r)},300)},5e3)}getToastIcon(t){const e={success:'<i class="bi bi-check-circle-fill"></i>',error:'<i class="bi bi-x-circle-fill"></i>',warning:'<i class="bi bi-exclamation-triangle-fill"></i>',info:'<i class="bi bi-info-circle-fill"></i>'};return e[t]||e.info}updateChart(t,e){if(this.chartInstances[t]){this.chartInstances[t].data=e;this.chartInstances[t].update('active')}}showLoading(){const t=document.createElement('div');t.className='reporte-loading';t.id='reporteLoading';t.innerHTML=`
            <div class="reporte-loading-spinner"></div>
            <div class="reporte-loading-text">Cargando datos...</div>
        `;document.body.appendChild(t)}hideLoading(){const t=document.getElementById('reporteLoading');if(t){t.remove()}}destroy(){Object.values(this.chartInstances).forEach(t=>{if(t&&typeof t.destroy==='function'){t.destroy()}});this.chartInstances={};Object.keys(this.debounceTimers).forEach(t=>{clearTimeout(this.debounceTimers[t])});this.debounceTimers={}}}document.addEventListener('DOMContentLoaded',function(){if(!window.reporteManager){window.reporteManager=new ReporteManager}});window.exportarReporte=function(){if(window.reporteManager){window.reporteManager.exportarPDF()}};const s=document.createElement('style');s.textContent='.spin{animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}';document.head.appendChild(s);
